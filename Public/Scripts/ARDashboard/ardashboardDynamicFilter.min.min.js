(function(j,i,f){var g=j.dandelion,h=g.namespace("App.ARDashboard.DynamicFilter",j);h.status={};h.status.filterId="";h.status.predicate="";h.status.areControlsEnabled=false;h.htmlBindings={};h.htmlBindings.filterFieldsContainer="#dynamicFilter_filterFieldsContainer";h.htmlBindings.filterFields_btnAdd=".filter-field";h.htmlBindings.filterField_btnRemove=".input-group-btn button";h.htmlBindings.controls={};h.htmlBindings.controls.btnToggleVisibility="#dynamicFilter_btnToggleVisibility";h.htmlBindings.controls.btnReset="#dynamicFilter_btnReset";h.htmlBindings.controls.btnSave="#dynamicFilter_btnSave";h.htmlBindings.controls.btnFilter="#dynamicFilter_btnFilter";h.htmlBindings.drpSavedFilters="#dynamicFilter_drpSavedFilters";h.htmlBindings.drpSavedFilterItems=".saved-filter-list-item";h.htmlBindings.drpSavedFilterItems_btnDelete="#dynamicFilter_drpSavedFilters li .close";h.htmlBindings.modalSaveFilter="#dynamicFilter_modal_saveFilter";h.htmlBindings.modalSaveFilter_txtName="#dynamicFilter_modal_txtFilterName";h.htmlBindings.modalSaveFilter_btnSave="#dynamicFilter_modal_btnSaveFilter";h.functions={};h.functions.disableControls=function(){g.js.foreachPropertyDo(h.htmlBindings.controls,function(a){i(a).addClass("disabled")});h.status.areControlsEnabled=false};h.functions.enableControls=function(){g.js.foreachPropertyDo(h.htmlBindings.controls,function(a){i(a).removeClass("disabled")});h.status.areControlsEnabled=true};h.functions.reset=function(a){i(h.htmlBindings.filterFieldsContainer).empty();h.functions.disableControls();i(h.htmlBindings.controls.btnFilter).next().focus();if(!a){h.functions.filter()}};h.functions.getPredicate=function(){var m=i(h.htmlBindings.filterFieldsContainer).children(),b=null,c="",d=null,e="",n="",a;h.status.predicate="";m.each(function(){b=i(this);if(b.hasClass("btn-group")){c=b.children("button").text();h.status.predicate+=c+" "}else{if(b.hasClass("form-group")){d=b.find("input, select");e=d.val();n=d.data("fieldname");if(e===""){h.status.predicate+="EMPTY("+n+") "}else{if(d.hasClass("daterangepicker")){a=e.split(" - ");h.status.predicate+="("+n+" >= '"+a[0]+"' AND "+n+" <= '"+a[1]+"') "}else{if(d.hasClass("daterangepicker-single")){h.status.predicate+=n+" = '"+e+"' "}else{if(d.data("valueType")==="numeric"){h.status.predicate+=n+" = "+e+" "}else{h.status.predicate+="LOWER("+n+") LIKE '%"+e.toLowerCase()+"%' "}}}}}else{throw"Unexpected filter component. Must be an 'btn-group' or 'form-group'."}}});return h.status.predicate};h.functions.filter=function(){f.ARDashboard.functions.paginate()};h.functions.loadFilter=function(a){i.ajax({data:{filterid:a},url:f.ARDashboard.urls.getSavedFilter,type:"post",beforeSend:function(){i(".loading").show()},success:function(d){var b=i.parseJSON(d),e,c;if(b.success){e=b.expfrom.split(", ");c=i(h.htmlBindings.filterFieldsContainer);c.append(b.expfields);c.find("select, input").each(function(l){i(this).val(e[l])});h.functions.bindOperatorGroupsEventHandlers();h.functions.bindFormGroupsEnventhandlers();i(h.htmlBindings.controls.btnToggleVisibility).click();h.functions.filter()}else{throw"Filter not loaded"}i(".loading").hide()}})};h.functions.createOperatorGroup=function(a){var b='<div class="btn-group"><button type="button" class="btn btn-default btn-filter-modifier disabled" style="opacity:1"></button><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button><ul class="dropdown-menu"><li class="current"><a href="#" style="display: inline-block; height: 26px; width: 100%;">Clear Not</a></li><li><a href="#">Not</a></li></ul></div>',c='<div class="btn-group "><button type="button" class="btn btn-default btn-filter-modifier disabled" style="opacity:1">And</button><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button><ul class="dropdown-menu"><li class="current"><a href="#">And</a></li><li><a href="#">And Not</a></li><li class="divider"></li><li><a href="#">Or</a></li><li><a href="#">Or Not</a></li></ul></div>';if(a===true){return i(b)}return i(c)};h.functions.createTextField=function(b,c,a){return i('<div class="form-group" title="'+c+'"><label class="control-label">'+c+'</label><div class="input-group"><input type="text" class="form-control" data-value-type="'+a+'" data-fieldname="'+b+'" placeholder="'+c+'"><span class="input-group-btn"><button class="btn btn-default glyphicon-action-button glyphicon-minus btn-delete-filter-field" title="Delete Filter Field" type="button"></button></span></div></div>')};h.functions.createDropdownField=function(b,p,e,a){var d=i('<div class="form-group" title="'+p+'"><label class="control-label">'+p+'</label><div class="input-group select2-bootstrap-append"><select class="form-control select2-container" data-value-type="'+a+'" data-fieldname="'+b+'"></select><span class="input-group-btn"><button class="btn btn-default glyphicon-action-button glyphicon-minus btn-delete-filter-field" title="Delete Filter Field" type="button"></button></span></div></div>'),n=d.find("select"),o,c;for(o in e){if(e.hasOwnProperty(o)){c=e[o];n.append(i('<option value="'+c.id+'">'+c.descrip+"</option>"))}}return d};h.functions.createDateField=function(a,d,c){var b=c?"daterangepicker":"daterangepicker-single";return i('<div class="form-group"><label class="control-label">'+d+'</label><div class="input-prepend input-group" title="'+d+'"><span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span><input type="text" class="form-control '+b+'" data-fieldname="'+a+'" placeholder="'+d+'"><span class="input-group-btn"><button type="button" class="btn btn-default glyphicon-action-button glyphicon-minus btn-delete-filter-field"></button></span></div></div>')};h.functions.createDropdownSavedFilters=function(a,b){var c='<button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>';c+='<ul id="'+a.slice(1)+'" class="dropdown-menu" role="menu"><li role="presentation" class="dropdown-header">'+b+"</li></ul>";return i(c)};h.functions.createDropdownSavedFilterItem=function(b,c){var d='<li><a href="#" class="saved-filter-list-item" data-filterid="'+b+'">'+c+'</a><button type="button" class="close" aria-hidden="true">&times;</button></li>',a=i(d);a.children("a").on("click",h.eventHandlers.drpSavedFilterItem_onClick);a.find("button.close").on("click",h.eventHandlers.drpSavedFilterItem_btnDelete_onClick);return a};h.functions.bindOperatorGroupEventHandler=function(a){a.find("li").on("click",h.eventHandlers.filterOperator_onClick)};h.functions.bindOperatorGroupsEventHandlers=function(){i(h.htmlBindings.filterFieldsContainer).find(".btn-group").each(function(){h.functions.bindOperatorGroupEventHandler(i(this))})};h.functions.bindFormGroupEventHandlers=function(a){a.find(h.htmlBindings.filterField_btnRemove).on("click",h.eventHandlers.filterField_btnRemove_onClick);a.find("input").on("keypress",h.eventHandlers.input_onKeyPress);a.find("input.daterangepicker").daterangepicker({singleDatePicker:false,format:"MM/DD/YYYY",startDate:j.moment(),endDate:j.moment()});a.find("input.daterangepicker-single").daterangepicker({singleDatePicker:true,format:"MM/DD/YYYY",startDate:j.moment(),endDate:j.moment()});a.find("select").select2()};h.functions.bindFormGroupsEnventhandlers=function(){i(h.htmlBindings.filterFieldsContainer).find(".form-group").each(function(){h.functions.bindFormGroupEventHandlers(i(this))})};h.eventHandlers={};h.eventHandlers.input_onKeyPress=function(a){if(a.keyCode===13){h.functions.filter()}};h.eventHandlers.btnFilter_onClick=function(){h.functions.filter()};h.eventHandlers.btnToggleVisibility_onClick=function(b){var a=i(b.target),c=a.html();if(c==="Hide"){i(h.htmlBindings.filterFieldsContainer).hide("slow");a.html("Show")}else{i(h.htmlBindings.filterFieldsContainer).show("slow");a.html("Hide")}};h.eventHandlers.btnReset_onClick=function(){h.functions.reset()};h.eventHandlers.btnSave_onClick=function(){var a=i(h.htmlBindings.modalSaveFilter_txtName);a.val("");a.popover("hide").focus().parent().removeClass("has-error");i(h.htmlBindings.modalSaveFilter).modal("show")};h.eventHandlers.drpSavedFilterItem_onClick=function(a){var b=a.currentTarget.dataset.filterid;h.functions.reset(true);h.functions.loadFilter(b);h.functions.enableControls()};h.eventHandlers.drpSavedFilterItem_btnDelete_onClick=function(b){var c=i(b.currentTarget),a=c.prev(),d=a.data("filterid");i.ajax({data:{filterId:d},url:f.ARDashboard.urls.deleteFilter,type:"post",beforeSend:function(){i(".loading").show()},success:function(m){var e=i.parseJSON(m),n=i(h.htmlBindings.drpSavedFilters);if(n.children().length>2){i('[data-filterid="'+e.filterid+'"]').parent().remove()}else{n.prev("button").remove();n.remove()}i(".loading").hide()}})};h.eventHandlers.filterOperator_onClick=function(e){var l=i(e.target),b=l.html(),a=l.parent().parent(),c=a.parent(),d=c.children(":first");if(b==="Clear Not"){b=""}d.html(b);a.find("li.current").removeClass("current");l.parent().addClass("current");h.functions.filter()};h.eventHandlers.filterFields_btnAdd_onClick=function(q){var r=i(q.target),e=r.data("field-type"),p=i(h.htmlBindings.filterFieldsContainer),a=p.children().length===0,d=e==="date",b=[],o=h.functions.createOperatorGroup(a),c;p.append(o);h.functions.bindOperatorGroupEventHandler(o);if(e==="text"){c=h.functions.createTextField(r.data("field"),r.text())}else{if(e==="date"||e==="date-single"){c=h.functions.createDateField(r.data("field"),r.text(),d)}else{if(e==="dropdown"){b=j.App.ARDashboard.dictionaries[r.data("field-collection")];c=h.functions.createDropdownField(r.data("field"),r.text(),b,r.data("field-value-type"))}}}p.append(c);h.functions.bindFormGroupEventHandlers(c);if(h.status.areControlsEnabled!==true){h.functions.enableControls()}};h.eventHandlers.filterField_btnRemove_onClick=function(c){var b=i(c.target),e=b.parent().parent().parent(),d=e.prev(),a=e.next();if(d.prev().length===0){if(a.length===0){d.remove();if(h.status.areControlsEnabled){h.functions.disableControls()}}else{a.remove()}}else{d.remove()}e.remove();h.functions.filter()};h.eventHandlers.modalSaveFilter_btnSave_onClick=function(){var d=i(h.htmlBindings.modalSaveFilter_txtName),c=d.val(),e=i(h.htmlBindings.filterFieldsContainer),b="",a="",l=i(h.htmlBindings.drpSavedFilters);e.find("select.select2-container").each(function(){i(this).select2("destroy")});b=e.html();e.find("select, input[type=text]").each(function(k){if(k===0){a+=i(this).val()}else{a+=", "+i(this).val()}});if(c!==""&&/\w/.test(c)){i.ajax({data:{filterName:c,filterString:h.functions.getPredicate(),filterHtml:b,filterValues:a},url:f.ARDashboard.urls.saveFilter,type:"post",beforeSend:function(){i(".loading").show()},success:function(o){var k=i.parseJSON(o),p;if(l.length===0){p=h.functions.createDropdownSavedFilters(h.htmlBindings.drpSavedFilters,"Load Saved Filter");i(h.htmlBindings.controls.btnSave).after(p);l=i(h.htmlBindings.drpSavedFilters)}l.append(h.functions.createDropdownSavedFilterItem(k.filterid,c));i(h.htmlBindings.modalSaveFilter).modal("hide");e.find("select.select2-container").select2();i(".loading").hide()}})}else{d.popover("show").focus().parent().addClass("has-error")}i(h.htmlBindings.modalSaveFilter).modal("hide")};h.init=function(a){if(a){h.status.filterId=a;h.functions.reset(true);h.functions.loadFilter(a);h.functions.enableControls()}else{h.functions.disableControls()}i(h.htmlBindings.controls.btnFilter).on("click",h.eventHandlers.btnFilter_onClick);i(h.htmlBindings.controls.btnToggleVisibility).on("click",h.eventHandlers.btnToggleVisibility_onClick);i(h.htmlBindings.controls.btnReset).on("click",h.eventHandlers.btnReset_onClick);i(h.htmlBindings.controls.btnSave).on("click",h.eventHandlers.btnSave_onClick);i(h.htmlBindings.filterFields_btnAdd).on("click",h.eventHandlers.filterFields_btnAdd_onClick);i(h.htmlBindings.modalSaveFilter_btnSave).on("click",h.eventHandlers.modalSaveFilter_btnSave_onClick);i(h.htmlBindings.drpSavedFilterItems).on("click",h.eventHandlers.drpSavedFilterItem_onClick);i(h.htmlBindings.drpSavedFilterItems_btnDelete).on("click",h.eventHandlers.drpSavedFilterItem_btnDelete_onClick)}}(window,window.jQuery,window.App));