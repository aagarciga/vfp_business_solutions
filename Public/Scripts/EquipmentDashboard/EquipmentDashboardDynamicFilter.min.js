(function(c,d,b){var a=c.dandelion,e=a.namespace("App.EquipmentDashboard.DynamicFilter",c);e.status={};e.status.filterId="";e.status.predicate="";e.status.areControlsEnabled=false;e.htmlBindings={};e.htmlBindings.filterFieldsContainer="#dynamicFilter_filterFieldsContainer";e.htmlBindings.filterFields_btnAdd=".filter-field";e.htmlBindings.filterField_btnRemove=".input-group-btn button";e.htmlBindings.controls={};e.htmlBindings.controls.btnToggleVisibility="#dynamicFilter_btnToggleVisibility";e.htmlBindings.controls.btnReset="#dynamicFilter_btnReset";e.htmlBindings.controls.btnSave="#dynamicFilter_btnSave";e.htmlBindings.controls.btnFilter="#dynamicFilter_btnFilter";e.htmlBindings.drpSavedFilters="#dynamicFilter_drpSavedFilters";e.htmlBindings.drpSavedFilterItems=".saved-filter-list-item";e.htmlBindings.drpSavedFilterItems_btnDelete="#dynamicFilter_drpSavedFilters li .close";e.htmlBindings.modalSaveFilter="#dynamicFilter_modal_saveFilter";e.htmlBindings.modalSaveFilter_txtName="#dynamicFilter_modal_txtFilterName";e.htmlBindings.modalSaveFilter_btnSave="#dynamicFilter_modal_btnSaveFilter";e.functions={};e.functions.disableControls=function(){a.js.foreachPropertyDo(e.htmlBindings.controls,function(f){d(f).addClass("disabled")});e.status.areControlsEnabled=false};e.functions.enableControls=function(){a.js.foreachPropertyDo(e.htmlBindings.controls,function(f){d(f).removeClass("disabled")});e.status.areControlsEnabled=true};e.functions.reset=function(f){d(e.htmlBindings.filterFieldsContainer).empty();e.functions.disableControls();d(e.htmlBindings.controls.btnFilter).next().focus();if(!f){e.functions.filter()}};e.functions.splitDate=function(g){var f=g.split("/");if(f===3){return f}return["","",""]};e.functions.splitDateRange=function(k){var f=k.split("-");if(f.length===2){var h=f[0],j=f[1];var g=e.functions.splitDate(h),i=e.functions.splitDate(j);return{inferiorLimit:g,superLimit:i}}return{inferiorLimit:["","",""],superLimit:["","",""]}};e.functions.getFilterTree=function(){var g=d(e.htmlBindings.filterFieldsContainer).children();var i=(function(){function l(m,n,o){this.nodeType=m;this.nodeValue=n;this.nodeChildren=o}return l})();var j=[];var h=[];var k=null;g.each(function(){var u=d(this);var t;var p;var s;var w;var q;if(u.hasClass("btn-group unary-logical-operator")){t=u.children("button").text();if(t===""){q=new i("positive","")}else{if(t==="Not"){q=new i("not","")}}k=q}else{if(u.hasClass("form-group")){p=u.find("input, select");s=p.val();w=p.data("fieldname");var v=w;var r=e.status.fieldsDefinition[v]["table"];var o=e.status.fieldsDefinition[v]["displayName"];var n=new i("field",[v,r,o],[]);if(p.hasClass("daterangepicker")){var y=e.functions.splitDateRange(s);var l=new i("date",y.inferiorLimit,[]);var m=new i("date",y.superLimit,[]);q=new i("dateRange","",[n,l,m])}else{var x=new i("string",s,[]);q=new i("like","",[n,x])}k.nodeChildren=[q];j.push(k)}else{if(u.hasClass("binary-logical-operator")){t=u.children("button").text();h.push(t)}}}});var f=new i("blockExpression",h,j);return f};e.functions.getPredicate=function(){var g=d(e.htmlBindings.filterFieldsContainer).children(),k=null,j="",i=null,h="",f="",l;e.status.predicate="";g.each(function(){k=d(this);if(k.hasClass("btn-group")){j=k.children("button").text();e.status.predicate+=j+" "}else{if(k.hasClass("form-group")){i=k.find("input, select");h=i.val();f=i.data("fieldname");var o=f;var m=e.status.fieldsDefinition[o]["table"];var n="["+m+"].["+o+"]";if(h===""){e.status.predicate+="EMPTY("+n+") "}else{if(i.hasClass("daterangepicker")){l=h.split(" - ");e.status.predicate+="("+n+" >= '"+l[0]+"' AND "+n+" <= '"+l[1]+"') "}else{if(i.hasClass("daterangepicker-single")){e.status.predicate+=n+" = '"+h+"' "}else{if(i.data("value-type")==="numeric"){e.status.predicate+=n+" = "+h+" "}else{e.status.predicate+="LOWER("+n+") LIKE '%"+h.toLowerCase()+"%' "}}}}}else{throw"Unexpected filter component. Must be an 'btn-group' or 'form-group'."}}});return e.status.predicate};e.functions.filter=function(){b.EquipmentDashboard.functions.paginate()};e.functions.loadFilter=function(f){d.ajax({data:{filterid:f},url:b.EquipmentDashboard.urls.getSavedFilter,type:"post",beforeSend:function(){d(".loading").show()},success:function(h){var j=d.parseJSON(h),g,i;if(j.success){g=j.expfrom.split(", ");i=d(e.htmlBindings.filterFieldsContainer);i.append(j.expfields);i.find("select, input").each(function(k){d(this).val(g[k])});e.functions.bindOperatorGroupsEventHandlers();e.functions.bindFormGroupsEnventhandlers();d(e.htmlBindings.controls.btnToggleVisibility).click();e.functions.filter()}else{throw"Filter not loaded"}d(".loading").hide()}})};e.functions.createOperatorGroup=function(h){var g='<div class="btn-group unary-logical-operator"><button type="button" class="btn btn-default btn-filter-modifier disabled" style="opacity:1"></button><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button><ul class="dropdown-menu"><li class="current"><a href="#" style="display: inline-block; height: 26px; width: 100%;">Clear Not</a></li><li><a href="#">Not</a></li></ul></div>',f='<div class="btn-group binary-logical-operator"><button type="button" class="btn btn-default btn-filter-modifier disabled" style="opacity:1">And</button><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button><ul class="dropdown-menu"><li class="current"><a href="#">And</a></li><li><a href="#">Or</a></li></ul></div>';if(h===true){return d(g)}return d(f)};e.functions.createTextField=function(g,f,h){return d('<div class="form-group" title="'+f+'"><label class="control-label">'+f+'</label><div class="input-group"><input type="text" class="form-control" data-value-type="'+h+'" data-fieldname="'+g+'" placeholder="'+f+'"><span class="input-group-btn"><button class="btn btn-default glyphicon-action-button glyphicon-minus btn-delete-filter-field" title="Delete Filter Field" type="button"></button></span></div></div>')};e.functions.createDropdownField=function(l,f,i,m){var j=d('<div class="form-group" title="'+f+'"><label class="control-label">'+f+'</label><div class="input-group select2-bootstrap-append"><select class="form-control select2-container" data-value-type="'+m+'" data-fieldname="'+l+'"></select><span class="input-group-btn"><button class="btn btn-default glyphicon-action-button glyphicon-minus btn-delete-filter-field" title="Delete Filter Field" type="button"></button></span></div></div>'),h=j.find("select"),g,k;for(g in i){if(i.hasOwnProperty(g)){k=i[g];h.append(d('<option value="'+k.id+'">'+k.descrip+"</option>"))}}return j};e.functions.createDateField=function(i,f,g){var h=g?"daterangepicker":"daterangepicker-single";return d('<div class="form-group"><label class="control-label">'+f+'</label><div class="input-prepend input-group" title="'+f+'"><span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span><input type="text" class="form-control '+h+'" data-fieldname="'+i+'" placeholder="'+f+'"><span class="input-group-btn"><button type="button" class="btn btn-default glyphicon-action-button glyphicon-minus btn-delete-filter-field"></button></span></div></div>')};e.functions.createDropdownSavedFilters=function(h,g){var f='<button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>';f+='<ul id="'+h.slice(1)+'" class="dropdown-menu" role="menu"><li role="presentation" class="dropdown-header">'+g+"</li></ul>";return d(f)};e.functions.createDropdownSavedFilterItem=function(h,g){var f='<li><a href="#" class="saved-filter-list-item" data-filterid="'+h+'">'+g+'</a><button type="button" class="close" aria-hidden="true">&times;</button></li>',i=d(f);i.children("a").on("click",e.eventHandlers.drpSavedFilterItem_onClick);i.find("button.close").on("click",e.eventHandlers.drpSavedFilterItem_btnDelete_onClick);return i};e.functions.bindOperatorGroupEventHandler=function(f){f.find("li").on("click",e.eventHandlers.filterOperator_onClick)};e.functions.bindOperatorGroupsEventHandlers=function(){d(e.htmlBindings.filterFieldsContainer).find(".btn-group").each(function(){e.functions.bindOperatorGroupEventHandler(d(this))})};e.functions.bindFormGroupEventHandlers=function(f){f.find(e.htmlBindings.filterField_btnRemove).on("click",e.eventHandlers.filterField_btnRemove_onClick);f.find("input").on("keypress",e.eventHandlers.input_onKeyPress);f.find("input.daterangepicker").daterangepicker({singleDatePicker:false,format:"MM/DD/YYYY",startDate:c.moment(),endDate:c.moment()});f.find("input.daterangepicker-single").daterangepicker({singleDatePicker:true,format:"MM/DD/YYYY",startDate:c.moment(),endDate:c.moment()});f.find("select").select2()};e.functions.bindFormGroupsEnventhandlers=function(){d(e.htmlBindings.filterFieldsContainer).find(".form-group").each(function(){e.functions.bindFormGroupEventHandlers(d(this))})};e.eventHandlers={};e.eventHandlers.input_onKeyPress=function(f){if(f.keyCode===13){e.functions.filter()}};e.eventHandlers.btnFilter_onClick=function(){e.functions.filter()};e.eventHandlers.btnToggleVisibility_onClick=function(g){var h=d(g.target),f=h.html();if(f==="Hide"){d(e.htmlBindings.filterFieldsContainer).hide("slow");h.html("Show")}else{d(e.htmlBindings.filterFieldsContainer).show("slow");h.html("Hide")}};e.eventHandlers.btnReset_onClick=function(){e.functions.reset()};e.eventHandlers.btnSave_onClick=function(){var f=d(e.htmlBindings.modalSaveFilter_txtName);f.val("");f.popover("hide").focus().parent().removeClass("has-error");d(e.htmlBindings.modalSaveFilter).modal("show")};e.eventHandlers.drpSavedFilterItem_onClick=function(g){var f=g.currentTarget.dataset.filterid;e.functions.reset(true);e.functions.loadFilter(f);e.functions.enableControls()};e.eventHandlers.drpSavedFilterItem_btnDelete_onClick=function(h){var g=d(h.currentTarget),i=g.prev(),f=i.data("filterid");d.ajax({data:{filterId:f},url:b.EquipmentDashboard.urls.deleteFilter,type:"post",beforeSend:function(){d(".loading").show()},success:function(k){var l=d.parseJSON(k),j=d(e.htmlBindings.drpSavedFilters);if(j.children().length>2){d('[data-filterid="'+l.filterid+'"]').parent().remove()}else{j.prev("button").remove();j.remove()}d(".loading").hide()}})};e.eventHandlers.filterOperator_onClick=function(g){var f=d(g.target),j=f.html(),k=f.parent().parent(),i=k.parent(),h=i.children(":first");if(j==="Clear Not"){j=""}h.html(j);k.find("li.current").removeClass("current");f.parent().addClass("current");e.functions.filter()};e.eventHandlers.filterFields_btnAdd_onClick=function(g){var f=d(g.target),j=f.data("field-type"),h=d(e.htmlBindings.filterFieldsContainer),o=h.children().length===0,l=j==="date",n=[],i=e.functions.createOperatorGroup(o),k,m;h.append(i);e.functions.bindOperatorGroupEventHandler(i);if(!o){k=e.functions.createOperatorGroup(true);h.append(k);e.functions.bindOperatorGroupEventHandler(k)}if(j==="text"){m=e.functions.createTextField(f.data("field"),f.text(),f.data("field-value-type"))}else{if(j==="date"||j==="date-single"){m=e.functions.createDateField(f.data("field"),f.text(),l)}else{if(j==="dropdown"){n=c.App.EquipmentDashboard.dictionaries[f.data("field-collection")];m=e.functions.createDropdownField(f.data("field"),f.text(),n,f.data("field-value-type"))}}}h.append(m);e.functions.bindFormGroupEventHandlers(m);if(e.status.areControlsEnabled!==true){e.functions.enableControls()}};e.eventHandlers.filterField_btnRemove_onClick=function(h){var i=d(h.target),f=i.parent().parent().parent(),g=f.prev(),j=f.next();if(g.prev().length===0){if(j.length===0){g.remove();if(e.status.areControlsEnabled){e.functions.disableControls()}}else{j.remove()}}else{g.remove()}f.remove();e.functions.filter()};e.eventHandlers.modalSaveFilter_btnSave_onClick=function(){var h=d(e.htmlBindings.modalSaveFilter_txtName),i=h.val(),g=d(e.htmlBindings.filterFieldsContainer),j="",k="",f=d(e.htmlBindings.drpSavedFilters);g.find("select.select2-container").each(function(){d(this).select2("destroy")});j=g.html();g.find("select, input[type=text]").each(function(l){if(l===0){k+=d(this).val()}else{k+=", "+d(this).val()}});if(i!==""&&/\w/.test(i)){d.ajax({data:{filterName:i,filterString:e.functions.getPredicate(),filterHtml:j,filterValues:k},url:b.EquipmentDashboard.urls.saveFilter,type:"post",beforeSend:function(){d(".loading").show()},success:function(l){console.log(l);var m=d.parseJSON(l),n;if(f.length===0){n=e.functions.createDropdownSavedFilters(e.htmlBindings.drpSavedFilters,"Load Saved Filter");d(e.htmlBindings.controls.btnSave).after(n);f=d(e.htmlBindings.drpSavedFilters)}f.append(e.functions.createDropdownSavedFilterItem(m.filterid,i));d(e.htmlBindings.modalSaveFilter).modal("hide");g.find("select.select2-container").select2();d(".loading").hide()}})}else{h.popover("show").focus().parent().addClass("has-error")}d(e.htmlBindings.modalSaveFilter).modal("hide")};e.init=function(g,f){e.status.fieldsDefinition=f;if(g){e.status.filterId=g;e.functions.reset(true);e.functions.loadFilter(g);e.functions.enableControls()}else{e.functions.disableControls()}d(e.htmlBindings.controls.btnFilter).on("click",e.eventHandlers.btnFilter_onClick);d(e.htmlBindings.controls.btnToggleVisibility).on("click",e.eventHandlers.btnToggleVisibility_onClick);d(e.htmlBindings.controls.btnReset).on("click",e.eventHandlers.btnReset_onClick);d(e.htmlBindings.controls.btnSave).on("click",e.eventHandlers.btnSave_onClick);d(e.htmlBindings.filterFields_btnAdd).on("click",e.eventHandlers.filterFields_btnAdd_onClick);d(e.htmlBindings.modalSaveFilter_btnSave).on("click",e.eventHandlers.modalSaveFilter_btnSave_onClick);d(e.htmlBindings.drpSavedFilterItems).on("click",e.eventHandlers.drpSavedFilterItem_onClick);d(e.htmlBindings.drpSavedFilterItems_btnDelete).on("click",e.eventHandlers.drpSavedFilterItem_btnDelete_onClick)}}(window,window.jQuery,window.App));