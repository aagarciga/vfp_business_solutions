(function(c,d,b){var a=c.dandelion,e=a.namespace("App.HistoryDashboard.ProjectFiles",c);e.status={};e.status.dropzone=null;e.status.jsTree=null;e.htmlBindings={};e.htmlBindings.modal_ProjectFiles="#project-files-modal";e.htmlBindings.dropzone="#projectFilesDropzone";e.htmlBindings.dropzone_previews=".dz-preview";e.htmlBindings.jsTree="#project-files-jstree";e.htmlBindings.jsTree_SearchControl="#tree-search";e.functions={};e.functions.dropzoneReset=function(){var f;for(f in e.status.dropzone.files){if(e.status.dropzone.files.hasOwnProperty(f)){e.status.dropzone.files[f].ready4Remove=false}}e.status.dropzone.removeAllFiles();d(e.htmlBindings.dropzone_previews).children(".dz-preview").remove();d(e.htmlBindings.dropzone).children(".dz-message.custom").css("opacity","1")};e.functions.bindJsTreeSearching=function(f){d(e.htmlBindings.jsTree_SearchControl).on("keyup",function(g){if(f){clearTimeout(f)}f=setTimeout(function(){var h=d(e.htmlBindings.jsTree_SearchControl).val();e.status.jsTree.jstree(true).search(h)},250)})};e.functions.loadFileTree=function(f){if(e.status.jsTree!==null){e.status.jsTree.jstree(true).destroy()}e.status.jsTree=d(e.htmlBindings.jsTree).jstree({id:e.htmlBindings.jsTree,plugins:["state","dnd","sort","types","contextmenu","unique","search"],searchControlId:e.htmlBindings.jsTree_SearchControl,core:{animation:true,themes:{name:"default",responsive:false,variant:"medium",stripes:false},data:{url:b.urls.treeViewManager.getNode+"&rootDir="+f,data:function(g){return{id:g.id}}},check_callback:function(g,i,k,j,h){if(h&&h.dnd&&h.pos!=="i"){return false}if(g==="move_node"||g==="copy_node"){if(this.get_node(i).parent===this.get_node(k).id){return false}}return true},error:function(g){console.log("Error callback:",g)}},sort:function(h,g){return this.get_type(h)===this.get_type(g)?(this.get_text(h)>this.get_text(g)?1:-1):(this.get_type(h)>=this.get_type(g)?1:-1)},types:{"#":{max_children:1,valid_children:["default"],icon:"glyphicon glyphicon-folder-open"},"default":{valid_children:["default"],icon:"glyphicon glyphicon-folder-close"}},contextmenu:{items:function(h){var g=d.jstree.defaults.contextmenu.items();delete g.ccp;if(this.get_type(h)==="file"){delete g.create}return g}},unique:{duplicate:function(h,g){return h+" "+g}}}).on("delete_node.jstree",function(g,h){var i={rootDir:f,operation:g.type,id:h.node.id};d(".loading").show();d.get(b.urls.treeViewManager.deleteNode,i).done(function(j){d(".loading").hide()}).fail(function(){h.instance.refresh();d(".loading").hide()})}).on("create_node.jstree",function(g,h){var i={rootDir:f,operation:g.type,type:h.node.type,id:h.node.parent,text:h.node.text};d(".loading").show();d.get(b.urls.treeViewManager.createNode,i).done(function(j){h.instance.set_id(h.node,j.id);d(".loading").hide()}).fail(function(){h.instance.refresh();d(".loading").hide()})}).on("rename_node.jstree",function(g,h){var i={rootDir:f,operation:g.type,id:h.node.id,text:h.text};d(".loading").show();d.get(b.urls.treeViewManager.renameNode,i).done(function(j){h.instance.set_id(h.node,j.id);d(".loading").hide()}).fail(function(){h.instance.refresh();d(".loading").hide()})}).on("move_node.jstree",function(g,h){var i={rootDir:f,operation:g.type,id:h.node.id,parent:h.parent};d(".loading").show();d.get(b.urls.treeViewManager.moveNode,i).done(function(j){h.instance.refresh();d(".loading").hide()}).fail(function(){h.instance.refresh();d(".loading").hide()})}).on("copy_node.jstree",function(g,h){var i={rootDir:f,operation:g.type,id:h.original.id,parent:h.parent};d(".loading").show();d.get(b.urls.treeViewManager.copyNode,i).done(function(j){h.instance.load_node(h.parent);h.instance.refresh();d(".loading").hide()}).fail(function(){h.instance.refresh();d(".loading").hide()})}).on("changed.jstree",function(i,j){var g=e.status.jsTree.jstree(true).get_selected()[0],h=(g==="/"?"":g+"/"),k={rootDir:f,selectedDir:g};if(g){e.functions.dropzoneReset();d.post(b.urls.fileManager.list,k).done(function(l){if(l&&l.length!==0){h="public/uploads/"+f+"/"+h;(function(m){}(e.status.dropzone));d.each(l,function(n,p){var o=/\.(gif|jpg|jpeg|tiff|png)$/i,m={name:p.name,size:p.size,ready4Remove:true};e.status.dropzone.options.addedfile.call(e.status.dropzone,m);e.status.dropzone.files.push(m);if(o.test(p.name)){e.status.dropzone.options.thumbnail.call(e.status.dropzone,m,h+p.name)}});d(e.htmlBindings.dropzone_previews).on("click",function(p){var m=m,q=d(this).find(".dz-filename span").html(),n=g,o=d('<form action="'+b.urls.fileManager.downloadFile+'" method="POST"><input type="hidden" name="rootDir" value="'+m+'" /><input type="hidden" name="selectedDir" value="'+n+'" /><input type="hidden" name="fileName" value="'+q+'" /></form>');o.appendTo("body");o[0].submit()})}}).fail(function(l){console.log(l)})}});e.functions.bindJsTreeSearching(false);e.status.jsTree.jstree(true).select_node(f)};e.functions.createDir=function(){var g=e.status.jsTree.jstree(true),f=g.get_selected();if(!f.length){return false}f=f[0];f=g.create_node(f,{type:"default"},"last",function(h){setTimeout(function(){g.edit(h)},0)})};e.functions.renameDir=function(){var g=e.status.jsTree.jstree(true),f=g.get_selected();if(!f.length){return false}f=f[0];g.edit(f)};e.functions.deleteDir=function(){var g=e.status.jsTree.jstree(true),f=g.get_selected();if(!f.length){return false}if(f[0]==="/"){throw"Project folder can't be deleted.";return false}g.delete_node(f);e.functions.dropzoneReset()};e.eventHandlers={};e.init=function(){c.Dropzone.options.projectFilesDropzone=false;e.status.dropzone=new c.Dropzone(e.htmlBindings.dropzone,{paramName:"file",maxFilesize:1024,maxThumbnailFilesize:1,addRemoveLinks:true,accept:function(g,f){if(g.name==="Alex.jpg"){f("Hello Creator.")}else{f()}},init:function(){this.on("removedfile",function(g){var f=e.status.jsTree.jstree(true).get_selected(),h={rootDir:b.HistoryDashboard.status.currentEquipid,selectedDir:f[0],fileName:g.name};if(g.ready4Remove){d(".loading").show();d.post(b.urls.fileManager.deleteFile,h).done(function(i){d(".loading").hide()}).fail(function(i){d(".loading").hide()})}g.ready4Remove=true});this.on("sending",function(h,j,i){var g=e.status.jsTree.jstree(true),f=g.get_selected();h.ready4Remove=true;h.uploadPath=b.HistoryDashboard.status.currentEquipid+"/"+f;if(b.HistoryDashboard.status.currentEquipid){i.append("rootDir",b.HistoryDashboard.status.currentEquipid);i.append("selectedDir",f)}d(e.htmlBindings.dropzone_previews).on("click",function(){var k=e.status.jsTree.jstree(true).get_selected()[0],l=b.HistoryDashboard.status.currentEquipid,n=d(this).find(".dz-filename span").html(),m=d('<form action="'+b.urls.fileManager.downloadFile+'" method="POST"><input type="hidden" name="rootDir" value="'+l+'" /><input type="hidden" name="selectedDir" value="'+k+'" /><input type="hidden" name="fileName" value="'+n+'" /></form>');m.appendTo("body");m[0].submit()})})}})}}(window,window.jQuery,window.App));