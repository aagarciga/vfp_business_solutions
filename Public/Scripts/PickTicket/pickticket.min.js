(function(d,e,c){var b=d.dandelion,a=b.namespace("App.PickTicket",d);a.status={};a.status.firstLoad=true;a.status.ticketVerified=false;a.status.locationVerified=false;a.status.itemVerified=false;a.status.defaultShowfinishedTickets=false;a.status.showfinishedTickets=false;a.status.currentItem=null;a.status.currentItemSuggestValue=0;a.status.modal_TicketList_CurrentTicket="";a.status.modal_TicketList_CurrentPage=1;a.status.modal_TicketList_ItemsPerPage=10;a.dictionaries={};a.messages={};a.messages.pickTicket="Pick Ticket.";a.messages.ticketVerified="Ticket Verified.";a.messages.ticketNotFound="Ticket not found.";a.messages.tikectReady="Pick Ticket is Ready, All Items Picked.";a.messages.locationVerified="Location verified.";a.messages.locationNotFound="Location not found.";a.messages.itemVerified="Item verified.";a.messages.itemNotVerified="Item not verified.";a.messages.itemNotFound="Item not found for current ticket.";a.messages.scanItem="Scan Item.";a.messages.qtyExceeds="Quantity Exceeds Required Qty";a.messages.suggestPickQty="Max quantity allowed to pick: ";a.htmlBindings={};a.htmlBindings.btnNewTicket="#btnNewTicket";a.htmlBindings.txtTicketId="#txtShpRelNo";a.htmlBindings.btnTicketNo="#btnTicketNo";a.htmlBindings.txtLocation="#txtLocation";a.htmlBindings.txtBarcode="#txtBarcode";a.htmlBindings.chkShowfinishedTickets="#chkShowfinishedTickets";a.htmlBindings.btnItemQty="#btnItemQty";a.htmlBindings.table_RelatedTicketItems="#related-tickets-items";a.htmlBindings.table_RelatedTicketItems_body="#related-tickets-items tbody";a.htmlBindings.table_RelatedTicketItems_body_btnItem=".btnItem";a.htmlBindings.qtyForm_btnEnter="";a.htmlBindings.modal_TicketList="#ticket-list-modal";a.htmlBindings.modal_TicketList_itemCounter="#itemCounter";a.htmlBindings.modal_TicketList_Pager_container=".pager-wrapper";a.htmlBindings.modal_TicketList_Pager_btnPagerPages=".pager-btn";a.htmlBindings.modal_TicketList_Table="#tickets";a.htmlBindings.modal_TicketList_Table_btnTicket=".ticket-link";a.functions={};a.functions.bindEventHandlers=function(){e(a.htmlBindings.btnNewTicket).on("click",a.eventHandlers.btnNewTicket_onClick);e(a.htmlBindings.btnTicketNo).on("click",a.eventHandlers.btnTicketNo_onClick);e(a.htmlBindings.txtTicketId).on("keypress",a.eventHandlers.txtTicketId_onKeyPress).on("blur",a.eventHandlers.txtTicketId_onLeave);e(a.htmlBindings.txtLocation).on("keypress",a.eventHandlers.txtLocation_onKeyPress).on("blur",a.eventHandlers.txtLocation_onLeave);e(a.htmlBindings.modal_TicketList_Pager_btnPagerPages).on("click",a.eventHandlers.modal_ticketList_pager_btnPagerPages_onClick);e(a.htmlBindings.chkShowfinishedTickets).on("change",a.eventHandlers.chkShowfinishedTickets_onChange);e(a.htmlBindings.txtBarcode).on("focus",a.eventHandlers.txtBarcode_onEnter).on("keypress",a.eventHandlers.txtBarcode_onKeyPress);e(a.htmlBindings.btnItemQty).on("click",a.eventHandlers.btnItemQty_onClick);e(c.QuantityForm.htmlBindings.enterKey).on("click",a.eventHandlers.qtyForm_btnEnter_onClick);a.functions.modal_ticketList_bindTableItemsEventHandlers()};a.functions.table_RelatedTicketItems_bindEventHandlers=function(){e(a.htmlBindings.table_RelatedTicketItems_body_btnItem).on("click",a.eventHandlers.table_RelatedTicketItems_body_btnItem_onClick)};a.functions.verifyTicket=function(f){e.ajax({data:{ticketId:f},url:a.url.verifyTicket,type:"post",beforeSend:function(){e(".loading").show()},success:function(g){var h=e.parseJSON(g);if(h.verified===true){a.status.ticketVerified=true;a.functions.getItemsByTicket(f);c.Helpers.setSuccessTo(a.htmlBindings.txtTicketId)}else{c.Helpers.setErrorTo(a.htmlBindings.txtTicketId);ShowFeedback(a.messages.ticketNotFound,"danger")}e(".loading").hide()}})};a.functions.verifyLocation=function(f){e.ajax({data:{location:f},url:a.url.verifyLocation,type:"post",beforeSend:function(){e(".loading").show()},success:function(g){var h=e.parseJSON(g);if(h.verified===true){a.status.locationVerified=true;c.Helpers.setSuccessTo(a.htmlBindings.txtLocation);ShowFeedback(a.messages.locationVerified,"success");e(a.htmlBindings.txtBarcode).focus()}else{c.Helpers.setErrorTo(a.htmlBindings.txtLocation);ShowFeedback(a.messages.locationNotFound,"danger")}e(".loading").hide()}})};a.functions.verifyItem=function(g){a.status.itemVerified=false;var f=e(a.htmlBindings.table_RelatedTicketItems_body_btnItem),h;for(h=0;h<f.length;h++){if((f[h].text).toLowerCase()===g.toLowerCase()){a.status.itemVerified=true;break}}};a.functions.getItemsByTicket=function(f){a.status.showfinishedTickets=e(a.htmlBindings.chkShowfinishedTickets)[0].checked;e.ajax({data:{ticket:f,showFinished:a.status.showfinishedTickets},url:a.url.getItemsByTicket,type:"post",beforeSend:function(){e(".loading").show()},success:function(g){var h=e.parseJSON(g);a.functions.showItemsByTicket(h);e(".loading").hide()}})};a.functions.showItemsByTicket=function(j){var g,k,m,i=0,f=0,l=e(a.htmlBindings.table_RelatedTicketItems_body),h=function(n,o){return parseInt(n)-parseInt(o)};l.empty();for(k in j){g=j[k];f+=1;if(g.qtypick===g.qtyshprel){m="finished";i+=1}else{m="unfinished"}l.append('<tr class="'+m+'"><td class="itemno"><a class="btnItem" href="#" data-suggest-value="'+h(g.qtyshprel,g.qtypick)+'" >'+g.itemno+'</a></td><td class="qty-left">'+g.qtyshprel+'</td><td class="qty-recv">'+g.qtypick+'</td><td class="binloc">'+g.locno+"</td></tr>")}a.functions.table_RelatedTicketItems_bindEventHandlers();if(i===f){ShowFeedback(a.messages.tikectReady,"warning")}else{ShowFeedback(a.messages.ticketVerified,"success")}};a.functions.modal_ticketList_paginate=function(){e.ajax({data:{page:a.status.modal_TicketList_CurrentPage,itemsPerPage:a.status.modal_TicketList_ItemsPerPage},url:a.url.getTicketPage,type:"post",beforeSend:function(){e(".loading").show()},success:function(i){var j=e.parseJSON(i),f=new BootstrapPager(j,a.eventHandlers.modal_ticketList_pager_btnPagerPages_onClick),h=f.getCurrentPagedItems(),g=f.getPagerControl();e(a.htmlBindings.modal_TicketList_Pager_container).empty().append(g);a.functions.modal_ticketList_updateTable(h);e(a.htmlBindings.modal_TicketList_itemCounter).html("("+f.itemsCount+")");e(".loading").hide()}})};a.functions.reset=function(){a.status.firstLoad=false;a.status.ticketVerified=false;if(e(a.htmlBindings.txtLocation).length===0){a.status.locationVerified=true}else{a.status.locationVerified=false}e(a.htmlBindings.chkShowfinishedTickets)[0].checked=a.status.showfinishedTickets=a.status.defaultShowfinishedTickets;e(a.htmlBindings.txtTicketId).parent().removeClass("has-success has-error");e(a.htmlBindings.txtLocation).parent().removeClass("has-success has-error");e(a.htmlBindings.txtTicketId).val("");e(a.htmlBindings.txtLocation).val("");a.functions.resetBarcode();e(a.htmlBindings.table_RelatedTicketItems_body).empty();ShowFeedback(a.messages.pickTicket,"info")};a.functions.resetBarcode=function(){a.status.itemVerified=false;e(a.htmlBindings.txtBarcode).parent().removeClass("has-success has-error");e(a.htmlBindings.txtBarcode).val("")};a.functions.showQtyForm=function(h,i){var f,g,j=function(k){var l=e(a.htmlBindings.table_RelatedTicketItems_body_btnItem);return l.each(function(){var m=e(this);if(m.html().toLowerCase()===k.toLowerCase()){return m}})};f=(i)?e(i):j(h);g=parseInt(f.data("suggest-value"));e(a.htmlBindings.txtBarcode).val(h).focus();if(g<0){ShowFeedback(a.messages.qtyExceeds,"danger")}else{a.status.currentItem=h;a.status.currentItemSuggestValue=g;c.QuantityForm.setUnknowkeyValue(g);c.QuantityForm.setUnknowkeyBehavior(function(k){console.log("entro en el callback");c.QuantityForm.setValue(g);a.eventHandlers.qtyForm_btnEnter_onClick(k);c.QuantityForm.hide()});ShowFeedback(a.messages.suggestPickQty+g,"info");c.QuantityForm.show()}};a.functions.update=function(f,g){console.log(f,g,a.status.currentItemSuggestValue)};a.functions.modal_ticketList_updateTable=function(f){var h=e(a.htmlBindings.modal_TicketList_Table),i=h.children("tbody"),g;i.empty();for(g in f){if(f.hasOwnProperty(g)){i.append(a.functions.modal_ticketList_buildTableItem(f[g],"","item-field"))}}a.functions.modal_ticketList_bindTableItemsEventHandlers()};a.functions.modal_ticketList_buildTableItem=function(j,n,k){var m=d.document,o=m.createElement("tr"),l=function(p){var q=m.createElement("td");q.className=k;q.appendChild(m.createTextNode(p));return q},g=function(s,r,p){var t=m.createElement("td"),q=m.createElement("a");q.href="#";q.className=r;q.dataset.ticketid=j.shprelno;if(typeof s==="string"){q.appendChild(m.createTextNode(s))}else{q.appendChild(s)}t.className=p||k;t.appendChild(q);return t},i=function(){return g(j.shprelno,a.htmlBindings.modal_TicketList_Table_btnTicket.slice(1))},f=function(){return l(j.ordnum)},h=function(){return l(j.company)};o.className=n;o.appendChild(i());o.appendChild(f());o.appendChild(h());return o};a.functions.modal_ticketList_bindTableItemsEventHandlers=function(){e(a.htmlBindings.modal_TicketList_Table_btnTicket).on("click",a.eventHandlers.modal_ticketList_table_btnTicket_onClick)};a.eventHandlers={};a.eventHandlers.btnNewTicket_onClick=function(){a.functions.reset()};a.eventHandlers.btnTicketNo_onClick=function(){if(a.status.firstLoad){a.functions.modal_ticketList_paginate()}e(a.htmlBindings.modal_TicketList).modal("show")};a.eventHandlers.txtTicketId_onKeyPress=function(f){var g=f.target.value;a.status.ticketVerified=false;if(f.keyCode===13){a.functions.verifyTicket(g)}};a.eventHandlers.txtLocation_onKeyPress=function(f){a.status.locationVerified=false;if(f.keyCode===13){a.functions.verifyLocation(f.target.value)}};a.eventHandlers.txtTicketId_onLeave=function(f){if(!a.status.ticketVerified){a.functions.verifyTicket(f.target.value)}};a.eventHandlers.txtLocation_onLeave=function(f){if(!a.status.locationVerified){a.functions.verifyLocation(f.target.value)}};a.eventHandlers.txtBarcode_onEnter=function(){var g,f;if(a.status.ticketVerified&&a.status.locationVerified){ShowFeedback(a.messages.scanItem,"info")}else{if(!a.status.ticketVerified){g=e(a.htmlBindings.txtTicketId).val();a.functions.verifyTicket(g)}else{if(!a.status.locationVerified){f=e(a.htmlBindings.txtLocation).focus().val();a.functions.verifyLocation(f)}}}};a.eventHandlers.txtBarcode_onKeyPress=function(f){a.status.itemVerified=false;if(f.keyCode===13){a.eventHandlers.btnItemQty_onClick()}};a.eventHandlers.chkShowfinishedTickets_onChange=function(){var f=e(a.htmlBindings.txtTicketId).val();if(!a.status.ticketVerified){a.functions.verifyTicket(f)}a.functions.getItemsByTicket(f)};a.eventHandlers.table_RelatedTicketItems_body_btnItem_onClick=function(h){var f=e(h.target),g;a.functions.verifyItem(f.html());if(a.status.itemVerified){g=parseInt(f.data("suggest-value"));if(g<0){ShowFeedback(a.messages.qtyExceeds,"danger")}else{a.functions.showQtyForm(f.html(),h.target);c.Helpers.setSuccessTo(a.htmlBindings.txtBarcode)}}else{c.Helpers.setErrorTo(a.htmlBindings.txtBarcode);e(a.htmlBindings.txtBarcode);ShowFeedback(a.messages.itemNotFound,"danger")}};a.eventHandlers.modal_ticketList_pager_btnPagerPages_onClick=function(g){var f=e(g.target),h=f.data("page");a.status.modal_TicketList_CurrentPage=h;a.functions.modal_ticketList_paginate()};a.eventHandlers.modal_ticketList_table_btnTicket_onClick=function(g){var f=e(g.target),h=f.data("ticketid");a.functions.reset();a.status.modal_TicketList_CurrentTicket=h;e(a.htmlBindings.txtTicketId).val(a.status.modal_TicketList_CurrentTicket).focus();a.functions.verifyTicket(h);e(a.htmlBindings.modal_TicketList).modal("hide")};a.eventHandlers.btnItemQty_onClick=function(){a.functions.verifyItem(e(a.htmlBindings.txtBarcode).val());if(a.status.itemVerified){c.Helpers.setSuccessTo(a.htmlBindings.txtBarcode);a.functions.showQtyForm(e(a.htmlBindings.txtBarcode).val())}else{c.Helpers.setErrorTo(a.htmlBindings.txtBarcode);e(a.htmlBindings.txtBarcode);ShowFeedback(a.messages.itemNotFound,"danger")}};a.eventHandlers.qtyForm_btnEnter_onClick=function(){console.log("entro aqui tambien");var f=c.QuantityForm.getValue();e(a.htmlBindings.txtBarcode).focus();if(f>a.status.currentItemSuggestValue){console.log("current value exceeds suggested value");ShowFeedback(a.messages.qtyExceeds+" by "+parseInt(f-a.status.currentItemSuggestValue),"danger")}else{a.functions.update(a.status.currentItem,f);a.functions.resetBarcode();ShowFeedback(a.messages.scanItem,"info")}};a.init=function(f){console.log("PickTicket Init");a.status.defaultShowfinishedTickets=f||false;if(e(a.htmlBindings.txtLocation).length===0){a.status.locationVerified=true;console.log("No location verification need")}a.functions.bindEventHandlers();c.QuantityForm.init();a.htmlBindings.qtyForm_btnEnter=c.QuantityForm.getEnterKeyId()}}(window,jQuery,App));