var fs=exports=module.exports={};fs._originalFs=require("fs");Object.getOwnPropertyNames(fs._originalFs).forEach(function(b){var a=Object.getOwnPropertyDescriptor(fs._originalFs,b);Object.defineProperty(fs,b,a)});var queue=[],constants=require("constants");fs._curOpen=0;fs.MIN_MAX_OPEN=64;fs.MAX_OPEN=1024;function OpenReq(c,b,d,a){this.path=c;this.flags=b;this.mode=d;this.cb=a}function noop(){}fs.open=gracefulOpen;function gracefulOpen(c,b,d,a){if(typeof d==="function"){a=d,d=null}if(typeof a!=="function"){a=noop}if(fs._curOpen>=fs.MAX_OPEN){queue.push(new OpenReq(c,b,d,a));setTimeout(flush);return}open(c,b,d,function(f,e){if(f&&f.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.open(c,b,d,a)}a(f,e)})}function open(c,b,d,a){a=a||noop;fs._curOpen++;fs._originalFs.open.call(fs,c,b,d,function(f,e){if(f){onclose()}a(f,e)})}fs.openSync=function(c,a,d){var b;b=fs._originalFs.openSync.call(fs,c,a,d);fs._curOpen++;return b};function onclose(){fs._curOpen--;flush()}function flush(){while(fs._curOpen<fs.MAX_OPEN){var a=queue.shift();if(!a){return}switch(a.constructor.name){case"OpenReq":open(a.path,a.flags||"r",a.mode||511,a.cb);break;case"ReaddirReq":readdir(a.path,a.cb);break;case"ReadFileReq":readFile(a.path,a.options,a.cb);break;case"WriteFileReq":writeFile(a.path,a.data,a.options,a.cb);break;default:throw new Error("Unknown req type: "+a.constructor.name)}}}fs.close=function(b,a){a=a||noop;fs._originalFs.close.call(fs,b,function(c){onclose();a(c)})};fs.closeSync=function(a){try{return fs._originalFs.closeSync.call(fs,a)}finally{onclose()}};fs.readdir=gracefulReaddir;function gracefulReaddir(b,a){if(fs._curOpen>=fs.MAX_OPEN){queue.push(new ReaddirReq(b,a));setTimeout(flush);return}readdir(b,function(d,c){if(d&&d.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.readdir(b,a)}a(d,c)})}function readdir(b,a){a=a||noop;fs._curOpen++;fs._originalFs.readdir.call(fs,b,function(d,c){onclose();a(d,c)})}function ReaddirReq(b,a){this.path=b;this.cb=a}fs.readFile=gracefulReadFile;function gracefulReadFile(c,b,a){if(typeof b==="function"){a=b,b=null}if(typeof a!=="function"){a=noop}if(fs._curOpen>=fs.MAX_OPEN){queue.push(new ReadFileReq(c,b,a));setTimeout(flush);return}readFile(c,b,function(e,d){if(e&&e.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.readFile(c,b,a)}a(e,d)})}function readFile(c,b,a){a=a||noop;fs._curOpen++;fs._originalFs.readFile.call(fs,c,b,function(e,d){onclose();a(e,d)})}function ReadFileReq(c,b,a){this.path=c;this.options=b;this.cb=a}fs.writeFile=gracefulWriteFile;function gracefulWriteFile(d,c,b,a){if(typeof b==="function"){a=b,b=null}if(typeof a!=="function"){a=noop}if(fs._curOpen>=fs.MAX_OPEN){queue.push(new WriteFileReq(d,c,b,a));setTimeout(flush);return}writeFile(d,c,b,function(e){if(e&&e.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.writeFile(d,c,b,a)}a(e)})}function writeFile(d,c,b,a){a=a||noop;fs._curOpen++;fs._originalFs.writeFile.call(fs,d,c,b,function(e){onclose();a(e)})}function WriteFileReq(d,c,b,a){this.path=d;this.data=c;this.options=b;this.cb=a}var constants=require("constants");if(constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)){fs.lchmod=function(a,b,c){c=c||noop;fs.open(a,constants.O_WRONLY|constants.O_SYMLINK,b,function(e,d){if(e){c(e);return}fs.fchmod(d,b,function(f){fs.close(d,function(g){c(f||g)})})})};fs.lchmodSync=function(e,f){var c=fs.openSync(e,constants.O_WRONLY|constants.O_SYMLINK,f);var d,a;try{var b=fs.fchmodSync(c,f)}catch(g){d=g}try{fs.closeSync(c)}catch(g){a=g}if(d||a){throw (d||a)}return b}}if(!fs.lutimes){if(constants.hasOwnProperty("O_SYMLINK")){fs.lutimes=function(d,b,c,a){fs.open(d,constants.O_SYMLINK,function(f,e){a=a||noop;if(f){return a(f)}fs.futimes(e,b,c,function(g){fs.close(e,function(h){return a(g||h)})})})};fs.lutimesSync=function(g,a,c){var e=fs.openSync(g,constants.O_SYMLINK),f,b,d;try{var d=fs.futimesSync(e,a,c)}catch(h){f=h}try{fs.closeSync(e)}catch(h){b=h}if(f||b){throw (f||b)}return d}}else{if(fs.utimensat&&constants.hasOwnProperty("AT_SYMLINK_NOFOLLOW")){fs.lutimes=function(d,b,c,a){fs.utimensat(d,b,c,constants.AT_SYMLINK_NOFOLLOW,a)};fs.lutimesSync=function(c,a,b){return fs.utimensatSync(c,a,b,constants.AT_SYMLINK_NOFOLLOW)}}else{fs.lutimes=function(d,c,b,a){process.nextTick(a)};fs.lutimesSync=function(){}}}}fs.chown=chownFix(fs.chown);fs.fchown=chownFix(fs.fchown);fs.lchown=chownFix(fs.lchown);fs.chownSync=chownFixSync(fs.chownSync);fs.fchownSync=chownFixSync(fs.fchownSync);fs.lchownSync=chownFixSync(fs.lchownSync);function chownFix(a){if(!a){return a}return function(e,c,d,b){return a.call(fs,e,c,d,function(g,f){if(chownErOk(g)){g=null}b(g,f)})}}function chownFixSync(a){if(!a){return a}return function(d,b,c){try{return a.call(fs,d,b,c)}catch(e){if(!chownErOk(e)){throw e}}}}function chownErOk(a){if(!a||(!process.getuid||process.getuid()!==0)&&(a.code==="EINVAL"||a.code==="EPERM")){return true}}if(!fs.lchmod){fs.lchmod=function(b,c,a){process.nextTick(a)};fs.lchmodSync=function(){}}if(!fs.lchown){fs.lchown=function(d,b,c,a){process.nextTick(a)};fs.lchownSync=function(){}}if(process.platform==="win32"){var rename_=fs.rename;fs.rename=function rename(e,d,a){var c=Date.now();rename_(e,d,function b(f){if(f&&(f.code==="EACCES"||f.code==="EPERM")&&Date.now()-c<1000){return rename_(e,d,b)}a(f)})}}var read=fs.read;fs.read=function(d,b,g,e,a,c){var h;if(c&&typeof c==="function"){var f=0;h=function(k,i,j){if(k&&k.code==="EAGAIN"&&f<10){f++;return read.call(fs,d,b,g,e,a,h)}c.apply(this,arguments)}}return read.call(fs,d,b,g,e,a,h)};var readSync=fs.readSync;fs.readSync=function(c,b,f,d,a){var e=0;while(true){try{return readSync.call(fs,c,b,f,d,a)}catch(g){if(g.code==="EAGAIN"&&e<10){e++;continue}throw g}}};