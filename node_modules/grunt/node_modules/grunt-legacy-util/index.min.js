"use strict";var spawn=require("child_process").spawn;var nodeUtil=require("util");var path=require("path");var util=module.exports={};util.namespace=require("getobject");util.hooker=require("hooker");util.async=require("async");var _=util._=require("lodash");var which=require("which").sync;util.exit=require("exit");_.str=require("underscore.string");_.mixin(_.str.exports());util.callbackify=function(b){return function a(){var c=b.apply(this,arguments);var e=arguments.length;if(e===b.length){return}var d=arguments[e-1];if(typeof d==="function"){d(c)}}};util.error=function(a,b){if(!nodeUtil.isError(a)){a=new Error(a)}if(b){a.origError=b}return a};util.linefeed=process.platform==="win32"?"\r\n":"\n";util.normalizelf=function(a){return a.replace(/\r\n|\n/g,util.linefeed)};var kindsOf={};"Number String Boolean Function RegExp Array Date Error".split(" ").forEach(function(a){kindsOf["[object "+a+"]"]=a.toLowerCase()});util.kindOf=function(a){if(a==null){return String(a)}return kindsOf[kindsOf.toString.call(a)]||"object"};util.toArray=_.toArray;util.repeat=function(b,a){return new Array(b+1).join(a||" ")};util.pluralize=function(d,c,b){var a=c.split(b||"/");return d===1?(a[0]||""):(a[1]||"")};util.recurse=function(c,a,d){function b(i,g,k,h){var e;if(h.objs.indexOf(i)!==-1){e=new Error("Circular reference detected ("+h.path+")");e.path=h.path;throw e}var j,f;if(k&&k(i)===false){return i}else{if(util.kindOf(i)==="array"){return i.map(function(m,l){return b(m,g,k,{objs:h.objs.concat([i]),path:h.path+"["+l+"]",})})}else{if(util.kindOf(i)==="object"&&!Buffer.isBuffer(i)){j={};for(f in i){j[f]=b(i[f],g,k,{objs:h.objs.concat([i]),path:h.path+(/\W/.test(f)?'["'+f+'"]':"."+f),})}return j}else{return g(i)}}}}return b(c,a,d,{objs:[],path:""})};util.spawn=function(a,f){var c=function(n,l,m){l=_.rtrim(l);m=_.rtrim(m);var k={stdout:l,stderr:m,code:n,toString:function(){if(n===0){return l}else{if("fallback" in a){return a.fallback}else{if(a.grunt){return m||l}}}return m}};f(n===0||"fallback" in a?null:new Error(m),k,n)};var d,j;var i=/[\\\/]/g;if(a.grunt){d=process.execPath;j=process.execArgv.concat(process.argv[1],a.args)}else{try{if(!i.test(a.cmd)){d=which(a.cmd)}else{d=a.cmd.replace(i,path.sep)}}catch(e){c(127,"",String(e));return}j=a.args||[]}var b=spawn(d,j,a.opts);var h=new Buffer("");var g=new Buffer("");if(b.stdout){b.stdout.on("data",function(k){h=Buffer.concat([h,new Buffer(k)])})}if(b.stderr){b.stderr.on("data",function(k){g=Buffer.concat([g,new Buffer(k)])})}b.on("close",function(k){c(k,h.toString(),g.toString())});return b};