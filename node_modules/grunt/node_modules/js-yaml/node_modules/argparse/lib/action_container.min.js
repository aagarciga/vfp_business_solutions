"use strict";var format=require("util").format;var _=require("underscore");_.str=require("underscore.string");var $$=require("./const");var ActionHelp=require("./action/help");var ActionAppend=require("./action/append");var ActionAppendConstant=require("./action/append/constant");var ActionCount=require("./action/count");var ActionStore=require("./action/store");var ActionStoreConstant=require("./action/store/constant");var ActionStoreTrue=require("./action/store/true");var ActionStoreFalse=require("./action/store/false");var ActionVersion=require("./action/version");var ActionSubparsers=require("./action/subparsers");var argumentErrorHelper=require("./argument/error");var ActionContainer=module.exports=function ActionContainer(a){a=a||{};this.description=a.description;this.argumentDefault=a.argumentDefault;this.prefixChars=a.prefixChars||"";this.conflictHandler=a.conflictHandler;this._registries={};this.register("action",null,ActionStore);this.register("action","store",ActionStore);this.register("action","storeConst",ActionStoreConstant);this.register("action","storeTrue",ActionStoreTrue);this.register("action","storeFalse",ActionStoreFalse);this.register("action","append",ActionAppend);this.register("action","appendConst",ActionAppendConstant);this.register("action","count",ActionCount);this.register("action","help",ActionHelp);this.register("action","version",ActionVersion);this.register("action","parsers",ActionSubparsers);this._getHandler();this._actions=[];this._optionStringActions={};this._actionGroups=[];this._mutuallyExclusiveGroups=[];this._defaults={};this._regexpNegativeNumber=new RegExp("^[-]?[0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?$");this._hasNegativeNumberOptionals=[]};var ArgumentGroup=require("./argument/group");var MutuallyExclusiveGroup=require("./argument/exclusive");ActionContainer.prototype.register=function(a,c,b){this._registries[a]=this._registries[a]||{};this._registries[a][c]=b};ActionContainer.prototype._registryGet=function(b,c,a){if(3>arguments.length){a=null}return this._registries[b][c]||a};ActionContainer.prototype.setDefaults=function(a){a=a||{};for(var b in a){this._defaults[b]=a[b]}this._actions.forEach(function(c){if(c.dest in a){c.defaultValue=a[c.dest]}})};ActionContainer.prototype.getDefault=function(b){var a=(_.has(this._defaults,b))?this._defaults[b]:null;this._actions.forEach(function(c){if(c.dest===b&&_.has(c,"defaultValue")){a=c.defaultValue}});return a};ActionContainer.prototype.addArgument=function(e,d){e=e;d=d||{};if(!_.isArray(e)){throw new TypeError("addArgument first argument should be an array")}if(!_.isObject(d)||_.isArray(d)){throw new TypeError("addArgument second argument should be a hash")}if(!e||e.length===1&&this.prefixChars.indexOf(e[0][0])<0){if(e&&!!d.dest){throw new Error("dest supplied twice for positional argument")}d=this._getPositional(e,d)}else{d=this._getOptional(e,d)}if(_.isUndefined(d.defaultValue)){var c=d.dest;if(_.has(this._defaults,c)){d.defaultValue=this._defaults[c]}else{if(!_.isUndefined(this.argumentDefault)){d.defaultValue=this.argumentDefault}}}var a=this._popActionClass(d);if(!_.isFunction(a)){throw new Error(format('Unknown action "%s".',a))}var f=new a(d);var b=this._registryGet("type",f.type,f.type);if(!_.isFunction(b)){throw new Error(format('"%s" is not callable',b))}return this._addAction(f)};ActionContainer.prototype.addArgumentGroup=function(a){var b=new ArgumentGroup(this,a);this._actionGroups.push(b);return b};ActionContainer.prototype.addMutuallyExclusiveGroup=function(a){var b=new MutuallyExclusiveGroup(this,a);this._mutuallyExclusiveGroups.push(b);return b};ActionContainer.prototype._addAction=function(b){var a=this;this._checkConflict(b);this._actions.push(b);b.container=this;b.optionStrings.forEach(function(c){a._optionStringActions[c]=b});b.optionStrings.forEach(function(c){if(c.match(a._regexpNegativeNumber)){if(!_.any(a._hasNegativeNumberOptionals)){a._hasNegativeNumberOptionals.push(true)}}});return b};ActionContainer.prototype._removeAction=function(b){var a=this._actions.indexOf(b);if(a>=0){this._actions.splice(a,1)}};ActionContainer.prototype._addContainerActions=function(a){var e={};this._actionGroups.forEach(function(f){if(e[f.title]){throw new Error(format('Cannot merge actions - two groups are named "%s".',f.title))}e[f.title]=f});var d={};function c(f){return f.getName()}a._actionGroups.forEach(function(f){if(!e[f.title]){e[f.title]=this.addArgumentGroup({title:f.title,description:f.description})}f._groupActions.forEach(function(g){d[c(g)]=e[f.title]})},this);var b;a._mutuallyExclusiveGroups.forEach(function(f){b=this.addMutuallyExclusiveGroup({required:f.required});f._groupActions.forEach(function(g){d[c(g)]=b})},this);a._actions.forEach(function(g){var f=c(g);if(!!d[f]){d[f]._addAction(g)}else{this._addAction(g)}})};ActionContainer.prototype._getPositional=function(b,a){if(_.isArray(b)){b=_.first(b)}if(a.required){throw new Error('"required" is an invalid argument for positionals.')}if(a.nargs!==$$.OPTIONAL&&a.nargs!==$$.ZERO_OR_MORE){a.required=true}if(a.nargs===$$.ZERO_OR_MORE&&a.defaultValue===undefined){a.required=true}a.dest=b;a.optionStrings=[];return a};ActionContainer.prototype._getOptional=function(d,c){var g=this.prefixChars;var f=[];var e=[];d.forEach(function(h){if(g.indexOf(h[0])<0){throw new Error(format('Invalid option string "%s": must start with a "%s".',h,g))}f.push(h);if(h.length>1&&g.indexOf(h[1])>=0){e.push(h)}});var b=c.dest||null;delete c.dest;if(!b){var a=e.length?e[0]:f[0];b=_.str.strip(a,this.prefixChars);if(b.length===0){throw new Error(format('dest= is required for options like "%s"',f.join(", ")))}b=b.replace(/-/g,"_")}c.dest=b;c.optionStrings=f;return c};ActionContainer.prototype._popActionClass=function(b,a){a=a||null;var c=(b.action||a);delete b.action;var d=this._registryGet("action",c,c);return d};ActionContainer.prototype._getHandler=function(){var d=this.conflictHandler;var b="_handleConflict"+_.str.capitalize(d);var a=this[b];if(typeof a==="undefined"){var c="invalid conflict resolution value: "+d;throw new Error(c)}else{return a}};ActionContainer.prototype._checkConflict=function(c){var b=this._optionStringActions;var a=[];c.optionStrings.forEach(function(e){var f=b[e];if(typeof f!=="undefined"){a.push([e,f])}});if(a.length>0){var d=this._getHandler();d.call(this,c,a)}};ActionContainer.prototype._handleConflictError=function(b,c){var a=_.map(c,function(d){return d[0]});a=a.join(", ");throw argumentErrorHelper(b,format("Conflicting option string(s): %s",a))};ActionContainer.prototype._handleConflictResolve=function(b,c){var a=this;c.forEach(function(g){var d=g[0];var f=g[1];var e=f.optionStrings.indexOf(d);if(e>=0){f.optionStrings.splice(e,1)}delete a._optionStringActions[d];if(f.optionStrings.length===0){f.container._removeAction(f)}})};