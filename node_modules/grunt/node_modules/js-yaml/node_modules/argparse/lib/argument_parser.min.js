"use strict";var util=require("util");var format=require("util").format;var Path=require("path");var _=require("underscore");_.str=require("underscore.string");var $$=require("./const");var ActionContainer=require("./action_container");var argumentErrorHelper=require("./argument/error");var HelpFormatter=require("./help/formatter");var Namespace=require("./namespace");var ArgumentParser=module.exports=function ArgumentParser(b){var a=this;b=b||{};b.description=(b.description||null);b.argumentDefault=(b.argumentDefault||null);b.prefixChars=(b.prefixChars||"-");b.conflictHandler=(b.conflictHandler||"error");ActionContainer.call(this,b);b.addHelp=(b.addHelp===undefined||!!b.addHelp);b.parents=(b.parents||[]);b.prog=(b.prog||Path.basename(process.argv[1]));this.prog=b.prog;this.usage=b.usage;this.epilog=b.epilog;this.version=b.version;this.debug=(b.debug===true);this.formatterClass=(b.formatterClass||HelpFormatter);this.fromfilePrefixChars=b.fromfilePrefixChars||null;this._positionals=this.addArgumentGroup({title:"Positional arguments"});this._optionals=this.addArgumentGroup({title:"Optional arguments"});this._subparsers=null;var d=function(e){return e};this.register("type","auto",d);this.register("type",null,d);this.register("type","int",function(f){var e=parseInt(f,10);if(isNaN(e)){throw new Error(f+" is not a valid integer.")}return e});this.register("type","float",function(f){var e=parseFloat(f);if(isNaN(e)){throw new Error(f+" is not a valid float.")}return e});this.register("type","string",function(e){return""+e});var c=(this.prefixChars.indexOf("-")>-1)?"-":this.prefixChars[0];if(b.addHelp){this.addArgument([c+"h",c+c+"help"],{action:"help",defaultValue:$$.SUPPRESS,help:"Show this help message and exit."})}if(this.version!==undefined){this.addArgument([c+"v",c+c+"version"],{action:"version",version:this.version,defaultValue:$$.SUPPRESS,help:"Show program's version number and exit."})}b.parents.forEach(function(f){a._addContainerActions(f);if(f._defaults!==undefined){for(var e in f._defaults){if(f._defaults.hasOwnProperty(e)){a._defaults[e]=f._defaults[e]}}}})};util.inherits(ArgumentParser,ActionContainer);ArgumentParser.prototype.addSubparsers=function(c){if(!!this._subparsers){this.error("Cannot have multiple subparser arguments.")}c=c||{};c.debug=(this.debug===true);c.optionStrings=[];c.parserClass=(c.parserClass||ArgumentParser);if(!!c.title||!!c.description){this._subparsers=this.addArgumentGroup({title:(c.title||"subcommands"),description:c.description});delete c.title;delete c.description}else{this._subparsers=this._positionals}if(!c.prog){var d=this._getFormatter();var b=this._getPositionalActions();var a=this._mutuallyExclusiveGroups;d.addUsage(this.usage,b,a,"");c.prog=_.str.strip(d.formatHelp())}var e=this._popActionClass(c,"parsers");var f=new e(c);this._subparsers._addAction(f);return f};ArgumentParser.prototype._addAction=function(a){if(a.isOptional()){this._optionals._addAction(a)}else{this._positionals._addAction(a)}return a};ArgumentParser.prototype._getOptionalActions=function(){return this._actions.filter(function(a){return a.isOptional()})};ArgumentParser.prototype._getPositionalActions=function(){return this._actions.filter(function(a){return a.isPositional()})};ArgumentParser.prototype.parseArgs=function(c,d){var b;var a=this.parseKnownArgs(c,d);c=a[0];b=a[1];if(b&&b.length>0){this.error(format("Unrecognized arguments: %s.",b.join(" ")))}return c};ArgumentParser.prototype.parseKnownArgs=function(b,d){var a=this;b=b||process.argv.slice(2);d=d||new Namespace();a._actions.forEach(function(g){if(g.dest!==$$.SUPPRESS){if(!_.has(d,g.dest)){if(g.defaultValue!==$$.SUPPRESS){var e=g.defaultValue;if(_.isString(g.defaultValue)){e=a._getValue(g,e)}d[g.dest]=e}}}});_.keys(a._defaults).forEach(function(e){d[e]=a._defaults[e]});try{var c=this._parseKnownArgs(b,d);d=c[0];b=c[1];if(_.has(d,$$._UNRECOGNIZED_ARGS_ATTR)){b=_.union(b,d[$$._UNRECOGNIZED_ARGS_ATTR]);delete d[$$._UNRECOGNIZED_ARGS_ATTR]}return[d,b]}catch(f){this.error(f)}};ArgumentParser.prototype._parseKnownArgs=function(f,m){var o=this;var e=[];if(this.fromfilePrefixChars!==null){f=this._readArgsFromFiles(f)}function d(z){return z.getName()}var n,y;var i={};this._mutuallyExclusiveGroups.forEach(function(z){z._groupActions.forEach(function(A,B,C){y=d(A);if(!_.has(i,y)){i[y]=[]}n=i[y];n.push.apply(n,C.slice(0,B));n.push.apply(n,C.slice(B+1))})});var k={};var a=[];f.forEach(function(C,z){if(C==="--"){a.push("-");while(z<f.length){a.push("A");z++}}else{var B;var A=o._parseOptional(C);if(!A){B="A"}else{k[z]=A;B="O"}a.push(B)}});var x=a.join("");var g=[];var t=[];function s(C,B,z){g.push(C);var A=o._getValues(C,B);if(A!==C.defaultValue){t.push(C);if(!!i[d(C)]){i[d(C)].forEach(function(D){if(t.indexOf(D)>=0){throw argumentErrorHelper(C,format('Not allowed with argument "%s".',D.getName()))}})}}if(A!==$$.SUPPRESS){C.call(o,m,A,z)}}function p(O){var M=k[O];var C=M[0];var F=M[1];var N=M[2];var G=[];var J,E,z,L;while(true){if(!C){e.push(f[O]);return O+1}if(!!N){E=o._matchArgument(C,"A");var K=o.prefixChars;if(E===0&&K.indexOf(F[1])<0){G.push([C,[],F]);F=F[0]+N[0];var I=N.slice(1)||null;var A=o._optionStringActions;if(_.keys(A).indexOf(F)>=0){C=A[F];N=I}else{var B="ignored explicit argument %r";throw argumentErrorHelper(C,B)}}else{if(E===1){L=O+1;J=[N];G.push([C,J,F]);break}else{var P="ignored explicit argument %r";throw argumentErrorHelper(C,_.str.sprintf(P,N))}}}else{z=O+1;var H=x.substr(z);E=o._matchArgument(C,H);L=z+E;J=f.slice(z,L);G.push([C,J,F]);break}}if(G.length<1){throw new Error("length should be > 0")}for(var D=0;D<G.length;D++){s.apply(o,G[D])}return L}var v=o._getPositionalActions();function r(B){var z=x.substr(B);var A=o._matchArgumentsPartial(v,z);_.zip(v,A).forEach(function(D){var E=D[0];var F=D[1];if(F===undefined){return}var C=f.slice(B,B+F);B+=F;s(E,C)});v=v.slice(A.length);return B}var b=0;var w;var q=-1;Object.keys(k).forEach(function(z){q=Math.max(q,parseInt(z,10))});var u,j;while(b<=q){j=null;for(w in k){if(!k.hasOwnProperty(w)){continue}w=parseInt(w,10);if(w>=b){if(j!==null){j=Math.min(j,w)}else{j=w}}}if(b!==j){u=r(b);if(u>b){b=u;continue}else{b=u}}if(!k[b]){var c=f.slice(b,j);e=e.concat(c);b=j}b=p(b)}var h=r(b);e=e.concat(_.rest(f,h));if(v.length>0){o.error("too few arguments")}o._actions.forEach(function(z){if(z.required){if(_.indexOf(g,z)<0){o.error(format('Argument "%s" is required',z.getName()))}}});var l=false;o._mutuallyExclusiveGroups.forEach(function(A){if(A.required){l=_.any(A._groupActions,function(C){return _.contains(t,C)});if(!l){var z=[];A._groupActions.forEach(function(C){if(C.help!==$$.SUPPRESS){z.push(C.getName())}});z=z.join(" ");var B="one of the arguments "+z+" is required";o.error(B)}}});return[m,e]};ArgumentParser.prototype._readArgsFromFiles=function(c){var d=this;var a=require("fs");var b=[];c.forEach(function(i){if(d.fromfilePrefixChars.indexOf(i[0])<0){b.push(i)}else{try{var h=[];var e=i.slice(1);var g=a.readFileSync(e,"utf8");g=g.trim().split("\n");g.forEach(function(j){d.convertArgLineToArgs(j).forEach(function(k){h.push(k)});h=d._readArgsFromFiles(h)});b.push.apply(b,h)}catch(f){return d.error(f.message)}}});return b};ArgumentParser.prototype.convertArgLineToArgs=function(a){return[a]};ArgumentParser.prototype._matchArgument=function(c,e){var d=new RegExp("^"+this._getNargsPattern(c));var b=e.match(d);var a;if(!b){switch(c.nargs){case undefined:case null:a="Expected one argument.";break;case $$.OPTIONAL:a="Expected at most one argument.";break;case $$.ONE_OR_MORE:a="Expected at least one argument.";break;default:a="Expected %s argument(s)"}throw argumentErrorHelper(c,format(a,c.nargs))}return b[1].length};ArgumentParser.prototype._matchArgumentsPartial=function(c,f){var k=this;var l=[];var a,g,e;var d,b;var h=function(i){return i.length};for(d=c.length;d>0;d--){g="";a=c.slice(0,d);for(b=0;b<a.length;b++){g+=k._getNargsPattern(a[b])}g=new RegExp("^"+g);e=f.match(g);if(e&&e.length>0){e=e.splice(1);l=l.concat(e.map(h));break}}return l};ArgumentParser.prototype._parseOptional=function(f){var e,b,d,c;if(!f){return null}if(this.prefixChars.indexOf(f[0])<0){return null}if(!!this._optionStringActions[f]){return[this._optionStringActions[f],f,null]}if(f.length===1){return null}if(f.indexOf("=")>=0){var a=f.split("=");b=a[0];d=a[1];if(!!this._optionStringActions[b]){e=this._optionStringActions[b];return[e,b,d]}}c=this._getOptionTuples(f);if(c.length>1){var g=c.map(function(h){return h[1]});this.error(format('Ambiguous option: "%s" could match %s.',f,g.join(", ")))}else{if(c.length===1){return c[0]}}if(f.match(this._regexpNegativeNumber)){if(!_.any(this._hasNegativeNumberOptionals)){return null}}if(f.search(" ")>=0){return null}return[null,f,null]};ArgumentParser.prototype._getOptionTuples=function(d){var j=[];var f=this.prefixChars;var c;var a;var b;var i;if(f.indexOf(d[0])>=0&&f.indexOf(d[1])>=0){if(d.indexOf("=")>=0){var h=d.split("=",1);c=h[0];a=h[1]}else{c=d;a=null}for(i in this._optionStringActions){if(i.substr(0,c.length)===c){b=this._optionStringActions[i];j.push([b,i,a])}}}else{if(f.indexOf(d[0])>=0&&f.indexOf(d[1])<0){c=d;a=null;var g=d.substr(0,2);var e=d.substr(2);for(i in this._optionStringActions){b=this._optionStringActions[i];if(i===g){j.push([b,i,e])}else{if(i.substr(0,c.length)===c){j.push([b,i,a])}}}}else{throw new Error(format("Unexpected option string: %s.",d))}}return j};ArgumentParser.prototype._getNargsPattern=function(a){var b;switch(a.nargs){case undefined:case null:b="(-*A-*)";break;case $$.OPTIONAL:b="(-*A?-*)";break;case $$.ZERO_OR_MORE:b="(-*[A-]*)";break;case $$.ONE_OR_MORE:b="(-*A[A-]*)";break;case $$.REMAINDER:b="([-AO]*)";break;case $$.PARSER:b="(-*A[-AO]*)";break;default:b="(-*"+_.str.repeat("-*A",a.nargs)+"-*)"}if(a.isOptional()){b=b.replace(/-\*/g,"");b=b.replace(/-/g,"")}return b};ArgumentParser.prototype._getValues=function(e,b){var a=this;if(e.nargs!==$$.PARSER&&e.nargs!==$$.REMAINDER){b=b.filter(function(f){return f!=="--"})}var d,c;if(b.length===0&&e.nargs===$$.OPTIONAL){d=(e.isOptional())?e.constant:e.defaultValue;if(typeof(d)==="string"){d=this._getValue(e,d);this._checkValue(e,d)}}else{if(b.length===0&&e.nargs===$$.ZERO_OR_MORE&&e.optionStrings.length===0){d=(e.defaultValue||b);this._checkValue(e,d)}else{if(b.length===1&&(!e.nargs||e.nargs===$$.OPTIONAL)){c=b[0];d=this._getValue(e,c);this._checkValue(e,d)}else{if(e.nargs===$$.REMAINDER){d=b.map(function(f){return a._getValue(e,f)})}else{if(e.nargs===$$.PARSER){d=b.map(function(f){return a._getValue(e,f)});this._checkValue(e,d[0])}else{d=b.map(function(f){return a._getValue(e,f)});d.forEach(function(f){a._checkValue(e,f)})}}}}}return d};ArgumentParser.prototype._getValue=function(g,f){var a;var c=this._registryGet("type",g.type,g.type);if(!_.isFunction(c)){var d=format("%s is not callable",c);throw argumentErrorHelper(g,d)}try{a=c(f)}catch(h){var b=null;if(_.isString(g.type)){b=g.type}else{b=g.type.name||g.type.displayName||"<function>"}var i=format("Invalid %s value: %s",b,f);if(b==="<function>"){i+="\n"+h.message}throw argumentErrorHelper(g,i)}return a};ArgumentParser.prototype._checkValue=function(c,b){var d=c.choices;if(!!d){if((_.isString(d)||_.isArray(d))&&d.indexOf(b)!==-1){return}if(_.isObject(d)&&!_.isArray(d)&&d[b]){return}if(_.isString(d)){d=d.split("").join(", ")}else{if(_.isArray(d)){d=d.join(", ")}else{d=_.keys(d).join(", ")}}var a=format("Invalid choice: %s (choose from [%s])",b,d);throw argumentErrorHelper(c,a)}};ArgumentParser.prototype.formatUsage=function(){var a=this._getFormatter();a.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups);return a.formatHelp()};ArgumentParser.prototype.formatHelp=function(){var a=this._getFormatter();a.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups);a.addText(this.description);this._actionGroups.forEach(function(b){a.startSection(b.title);a.addText(b.description);a.addArguments(b._groupActions);a.endSection()});a.addText(this.epilog);return a.formatHelp()};ArgumentParser.prototype._getFormatter=function(){var b=this.formatterClass;var a=new b({prog:this.prog});return a};ArgumentParser.prototype.printUsage=function(){this._printMessage(this.formatUsage())};ArgumentParser.prototype.printHelp=function(){this._printMessage(this.formatHelp())};ArgumentParser.prototype._printMessage=function(a,b){if(!b){b=process.stdout}if(a){b.write(""+a)}};ArgumentParser.prototype.exit=function(a,b){if(!!b){if(a===0){this._printMessage(b)}else{this._printMessage(b,process.stderr)}}process.exit(a)};ArgumentParser.prototype.error=function(b){var a;if(b instanceof Error){if(this.debug===true){throw b}a=b.message}else{a=b}var c=format("%s: error: %s",this.prog,a)+$$.EOL;if(this.debug===true){throw new Error(c)}this.printUsage(process.stderr);return this.exit(2,c)};