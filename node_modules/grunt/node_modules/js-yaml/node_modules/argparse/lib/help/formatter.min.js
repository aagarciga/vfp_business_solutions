"use strict";var _=require("underscore");_.str=require("underscore.string");var $$=require("../const");function Section(a,b){this._parent=a;this._heading=b;this._items=[]}Section.prototype.addItem=function(a){this._items.push(a)};Section.prototype.formatHelp=function(a){var b,c;if(!!this._parent){a._indent()}b=this._items.map(function(g){var h,f,e;h=a;f=g[0];e=g[1];return f.apply(h,e)});b=a._joinParts(b);if(!!this._parent){a._dedent()}if(!b){return""}c="";if(!!this._heading&&this._heading!==$$.SUPPRESS){var d=a.currentIndent;c=_.str.repeat(" ",d)+this._heading+":"+$$.EOL}return a._joinParts([$$.EOL,c,b,$$.EOL])};var HelpFormatter=module.exports=function HelpFormatter(a){a=a||{};this._prog=a.prog;this._maxHelpPosition=a.maxHelpPosition||24;this._width=(a.width||((process.env.COLUMNS||80)-2));this._currentIndent=0;this._indentIncriment=a.indentIncriment||2;this._level=0;this._actionMaxLength=0;this._rootSection=new Section(null);this._currentSection=this._rootSection;this._whitespaceMatcher=new RegExp("\\s+","g");this._longBreakMatcher=new RegExp($$.EOL+$$.EOL+$$.EOL+"+","g")};HelpFormatter.prototype._indent=function(){this._currentIndent+=this._indentIncriment;this._level+=1};HelpFormatter.prototype._dedent=function(){this._currentIndent-=this._indentIncriment;this._level-=1;if(this._currentIndent<0){throw new Error("Indent decreased below 0.")}};HelpFormatter.prototype._addItem=function(b,a){this._currentSection.addItem([b,a])};HelpFormatter.prototype.startSection=function(c){this._indent();var b=new Section(this._currentSection,c);var a=b.formatHelp.bind(b);this._addItem(a,[this]);this._currentSection=b};HelpFormatter.prototype.endSection=function(){this._currentSection=this._currentSection._parent;this._dedent()};HelpFormatter.prototype.addText=function(a){if(!!a&&a!==$$.SUPPRESS){this._addItem(this._formatText,[a])}};HelpFormatter.prototype.addUsage=function(c,d,a,b){if(c!==$$.SUPPRESS){this._addItem(this._formatUsage,[c,d,a,b])}};HelpFormatter.prototype.addArgument=function(e){if(e.help!==$$.SUPPRESS){var c=this;var d=[this._formatActionInvocation(e)];var a=d[0].length;var b;if(!!e._getSubactions){this._indent();e._getSubactions().forEach(function(g){var f=c._formatActionInvocation(g);d.push(f);a=Math.max(a,f.length)});this._dedent()}b=a+this._currentIndent;this._actionMaxLength=Math.max(this._actionMaxLength,b);this._addItem(this._formatAction,[e])}};HelpFormatter.prototype.addArguments=function(b){var a=this;b.forEach(function(c){a.addArgument(c)})};HelpFormatter.prototype.formatHelp=function(){var a=this._rootSection.formatHelp(this);if(a){a=a.replace(this._longBreakMatcher,$$.EOL+$$.EOL);a=_.str.strip(a,$$.EOL)+$$.EOL}return a};HelpFormatter.prototype._joinParts=function(a){return a.filter(function(b){return(!!b&&b!==$$.SUPPRESS)}).join("")};HelpFormatter.prototype._formatUsage=function(p,g,o,l){if(!l&&!_.isString(l)){l="usage: "}g=g||[];o=o||[];if(p){p=_.str.sprintf(p,{prog:this._prog})}else{if(!p&&g.length===0){p=this._prog}else{if(!p){var e=this._prog;var i=[];var n=[];var f;var c;g.forEach(function(s){if(s.isOptional()){i.push(s)}else{n.push(s)}});f=this._formatActionsUsage([].concat(i,n),o);p=[e,f].join(" ");c=this._width-this._currentIndent;if((l.length+p.length)>c){var q=new RegExp("\\(.*?\\)+|\\[.*?\\]+|\\S+","g");var r=this._formatActionsUsage(i,o);var d=this._formatActionsUsage(n,o);var m=r.match(q);var b=d.match(q)||[];if(m.join(" ")!==r){throw new Error("assert \"optionalParts.join(' ') === optionalUsage\"")}if(b.join(" ")!==d){throw new Error("assert \"positionalParts.join(' ') === positionalUsage\"")}var k=function(x,t,w){var v=[];var u=[];var s=!!w?w.length-1:t.length-1;x.forEach(function(y){if(s+1+y.length>c){v.push(t+u.join(" "));u=[];s=t.length-1}u.push(y);s+=y.length+1});if(u){v.push(t+u.join(" "))}if(w){v[0]=v[0].substr(t.length)}return v};var a,h,j;if(l.length+e.length<=0.75*c){h=_.str.repeat(" ",(l.length+e.length+1));if(m){a=[].concat(k([e].concat(m),h,l),k(b,h))}else{if(b){a=k([e].concat(b),h,l)}else{a=[e]}}}else{h=_.str.repeat(" ",l.length);j=m+b;a=k(j,h);if(a.length>1){a=[].concat(k(m,h),k(b,h))}a=[e]+a}p=a.join($$.EOL)}}}}return l+p+$$.EOL+$$.EOL};HelpFormatter.prototype._formatActionsUsage=function(h,a){var g=[];var d=[];var b=this;a.forEach(function(l){var j;var k;var m=h.indexOf(l._groupActions[0]);if(m>=0){j=m+l._groupActions.length;if(_.isEqual(h.slice(m,j),l._groupActions)){l._groupActions.forEach(function(i){g.push(i)});if(!l.required){if(!!d[m]){d[m]+=" ["}else{d[m]="["}d[j]="]"}else{if(!!d[m]){d[m]+=" ("}else{d[m]="("}d[j]=")"}for(k=m+1;k<j;k+=1){d[k]="|"}}}});var e=[];h.forEach(function(n,l){var k;var i;var m;var j;if(n.help===$$.SUPPRESS){e.push(null);if(d[l]==="|"){d.splice(l,l)}else{if(d[l+1]==="|"){d.splice(l+1,l+1)}}}else{if(!n.isOptional()){k=b._formatArgs(n,n.dest);if(g.indexOf(n)>=0){if(k[0]==="["&&k[k.length-1]==="]"){k=k.slice(1,-1)}}e.push(k)}else{i=n.optionStrings[0];if(n.nargs===0){k=""+i}else{m=n.dest.toUpperCase();j=b._formatArgs(n,m);k=i+" "+j}if(!n.required&&g.indexOf(n)<0){k="["+k+"]"}e.push(k)}}});for(var c=d.length-1;c>=0;--c){if(d[c]!==null){e.splice(c,0,d[c])}}var f=e.filter(function(i){return !!i}).join(" ");f=f.replace(/([\[(]) /g,"$1");f=f.replace(/ ([\])])/g,"$1");f=f.replace(/\[ *\]/g,"");f=f.replace(/\( *\)/g,"");f=f.replace(/\(([^|]*)\)/g,"$1");f=_.str.strip(f);return f};HelpFormatter.prototype._formatText=function(b){b=_.str.sprintf(b,{prog:this._prog});var a=this._width-this._currentIndent;var c=_.str.repeat(" ",this._currentIndent);return this._fillText(b,a,c)+$$.EOL+$$.EOL};HelpFormatter.prototype._formatAction=function(b){var j=this;var i;var g;var d;var a;var f=Math.min(this._actionMaxLength+2,this._maxHelpPosition);var h=this._width-f;var e=f-this._currentIndent-2;var c=this._formatActionInvocation(b);if(!b.help){c=_.str.repeat(" ",this._currentIndent)+c+$$.EOL}else{if(c.length<=e){c=_.str.repeat(" ",this._currentIndent)+c+"  "+_.str.repeat(" ",e-c.length);a=0}else{c=_.str.repeat(" ",this._currentIndent)+c+$$.EOL;a=f}}d=[c];if(!!b.help){i=this._expandHelp(b);g=this._splitLines(i,h);d.push(_.str.repeat(" ",a)+g[0]+$$.EOL);g.slice(1).forEach(function(k){d.push(_.str.repeat(" ",f)+k+$$.EOL)})}else{if(c.charAt(c.length-1)!==$$.EOL){d.push($$.EOL)}}if(!!b._getSubactions){this._indent();b._getSubactions().forEach(function(k){d.push(j._formatAction(k))});this._dedent()}return this._joinParts(d)};HelpFormatter.prototype._formatActionInvocation=function(e){if(!e.isOptional()){var a=this._metavarFormatter(e,e.dest);var c=a(1);return c[0]}else{var f=[];var d;var b;if(e.nargs===0){f=f.concat(e.optionStrings)}else{d=e.dest.toUpperCase();b=this._formatArgs(e,d);e.optionStrings.forEach(function(g){f.push(g+" "+b)})}return f.join(", ")}};HelpFormatter.prototype._metavarFormatter=function(b,c){var a;if(!!b.metavar||b.metavar===""){a=b.metavar}else{if(!!b.choices){var d=b.choices;if(_.isString(d)){d=d.split("").join(", ")}else{if(_.isArray(d)){d=d.join(",")}else{d=_.keys(d).join(",")}}a="{"+d+"}"}else{a=c}}return function(f){if(Array.isArray(a)){return a}else{var g=[];for(var e=0;e<f;e+=1){g.push(a)}return g}}};HelpFormatter.prototype._formatArgs=function(d,e){var a;var b;var c=this._metavarFormatter(d,e);switch(d.nargs){case undefined:case null:b=c(1);a=""+b[0];break;case $$.OPTIONAL:b=c(1);a="["+b[0]+"]";break;case $$.ZERO_OR_MORE:b=c(2);a="["+b[0]+" ["+b[1]+" ...]]";break;case $$.ONE_OR_MORE:b=c(2);a=""+b[0]+" ["+b[1]+" ...]";break;case $$.REMAINDER:a="...";break;case $$.PARSER:b=c(1);a=b[0]+" ...";break;default:b=c(d.nargs);a=b.join(" ")}return a};HelpFormatter.prototype._expandHelp=function(a){var b={prog:this._prog};Object.keys(a).forEach(function(d){var c=a[d];if(c!==$$.SUPPRESS){b[d]=c}});if(!!b.choices){if(_.isString(b.choices)){b.choices=b.choices.split("").join(", ")}else{if(_.isArray(b.choices)){b.choices=b.choices.join(", ")}else{b.choices=_.keys(b.choices).join(", ")}}}return _.str.sprintf(this._getHelpString(a),b)};HelpFormatter.prototype._splitLines=function(e,c){var a=[];var d=[" ",".",",","!","?"];var b=new RegExp("["+d.join("")+"][^"+d.join("")+"]*$");e=e.replace(/[\n\|\t]/g," ");e=_.str.strip(e);e=e.replace(this._whitespaceMatcher," ");e.split($$.EOL).forEach(function(g){if(c>=g.length){a.push(g);return}var f=0;var h=c;var i=0;while(h<=g.length){if(h!==g.length&&d.indexOf(g[h]<-1)){i=(b.exec(g.substring(f,h))||{}).index;h=f+i+1}a.push(g.substring(f,h));f=h;h+=c}if(f<g.length){a.push(g.substring(f,h))}});return a};HelpFormatter.prototype._fillText=function(d,c,a){var b=this._splitLines(d,c);b=b.map(function(e){return a+e});return b.join($$.EOL)};HelpFormatter.prototype._getHelpString=function(a){return a.help};