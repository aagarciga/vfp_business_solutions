(function(){var c,f,a,r,i,k,h,p,s,j,e,n,q,g,l,b,t,m,d=[].indexOf||function(w){for(var v=0,u=this.length;v<u;v++){if(v in this&&this[v]===w){return v}}return -1},o=[].slice;exports.Rewriter=(function(){function u(){}u.prototype.rewrite=function(v){this.tokens=v;this.removeLeadingNewlines();this.removeMidExpressionNewlines();this.closeOpenCalls();this.closeOpenIndexes();this.addImplicitIndentation();this.tagPostfixConditionals();this.addImplicitBraces();this.addImplicitParentheses();return this.tokens};u.prototype.scanTokens=function(y){var w,v,x;x=this.tokens;w=0;while(v=x[w]){w+=y.call(this,v,w,x)}return true};u.prototype.detectEnd=function(x,C,A){var z,w,B,y,v;B=this.tokens;z=0;while(w=B[x]){if(z===0&&C.call(this,w,x)){return A.call(this,w,x)}if(!w||z<0){return A.call(this,w,x-1)}if(y=w[0],d.call(r,y)>=0){z+=1}else{if(v=w[0],d.call(a,v)>=0){z-=1}}x+=1}return x-1};u.prototype.removeLeadingNewlines=function(){var x,v,z,w,y;y=this.tokens;for(x=z=0,w=y.length;z<w;x=++z){v=y[x][0];if(v!=="TERMINATOR"){break}}if(x){return this.tokens.splice(0,x)}};u.prototype.removeMidExpressionNewlines=function(){return this.scanTokens(function(w,v,y){var x;if(!(w[0]==="TERMINATOR"&&(x=this.tag(v+1),d.call(f,x)>=0))){return 1}y.splice(v,1);return 0})};u.prototype.closeOpenCalls=function(){var v,w;w=function(y,x){var z;return((z=y[0])===")"||z==="CALL_END")||y[0]==="OUTDENT"&&this.tag(x-1)===")"};v=function(y,x){return this.tokens[y[0]==="OUTDENT"?x-1:x][0]="CALL_END"};return this.scanTokens(function(y,x){if(y[0]==="CALL_START"){this.detectEnd(x+1,w,v)}return 1})};u.prototype.closeOpenIndexes=function(){var v,w;w=function(y,x){var z;return(z=y[0])==="]"||z==="INDEX_END"};v=function(y,x){return y[0]="INDEX_END"};return this.scanTokens(function(y,x){if(y[0]==="INDEX_START"){this.detectEnd(x+1,w,v)}return 1})};u.prototype.addImplicitBraces=function(){var z,C,x,w,B,v,A,y;w=[];B=null;y=null;x=true;v=0;A=0;C=function(I,H){var G,E,J,F,K,D;K=this.tokens.slice(H+1,(H+3)+1||9000000000),G=K[0],F=K[1],J=K[2];if("HERECOMMENT"===(G!=null?G[0]:void 0)){return false}E=I[0];if(d.call(e,E)>=0){x=false}return(((E==="TERMINATOR"||E==="OUTDENT")||(d.call(h,E)>=0&&x&&!(H-A===1)))&&((!y&&this.tag(H-1)!==",")||!((F!=null?F[0]:void 0)===":"||(G!=null?G[0]:void 0)==="@"&&(J!=null?J[0]:void 0)===":")))||(E===","&&G&&((D=G[0])!=="IDENTIFIER"&&D!=="NUMBER"&&D!=="STRING"&&D!=="@"&&D!=="TERMINATOR"&&D!=="OUTDENT"))};z=function(F,E){var D;D=this.generate("}","}",F[2]);return this.tokens.splice(E,0,D)};return this.scanTokens(function(E,H,J){var I,L,D,N,M,K,G,F;if(G=(N=E[0]),d.call(r,G)>=0){w.push([(N==="INDENT"&&this.tag(H-1)==="{"?"{":N),H]);return 1}if(d.call(a,N)>=0){B=w.pop();return 1}if(!(N===":"&&((I=this.tag(H-2))===":"||((F=w[w.length-1])!=null?F[0]:void 0)!=="{"))){return 1}x=true;A=H+1;w.push(["{"]);L=I==="@"?H-2:H-1;while(this.tag(L-2)==="HERECOMMENT"){L-=2}D=this.tag(L-1);y=!D||(d.call(e,D)>=0);K=new String("{");K.generated=true;M=this.generate("{",K,E[2]);J.splice(L,0,M);this.detectEnd(H+2,C,z);return 2})};u.prototype.addImplicitParentheses=function(){var v,z,y,w,x;y=x=w=false;z=function(E,D){var C,B,F,A;B=E[0];if(!x&&E.fromThen){return true}if(B==="IF"||B==="ELSE"||B==="CATCH"||B==="->"||B==="=>"||B==="CLASS"){x=true}if(B==="IF"||B==="ELSE"||B==="SWITCH"||B==="TRY"||B==="="){w=true}if((B==="."||B==="?."||B==="::")&&this.tag(D-1)==="OUTDENT"){return true}return !E.generated&&this.tag(D-1)!==","&&(d.call(h,B)>=0||(B==="INDENT"&&!w))&&(B!=="INDENT"||(((F=this.tag(D-2))!=="CLASS"&&F!=="EXTENDS")&&(A=this.tag(D-1),d.call(i,A)<0)&&!((C=this.tokens[D+1])&&C.generated&&C[0]==="{")))};v=function(B,A){return this.tokens.splice(A,0,this.generate("CALL_END",")",B[2]))};return this.scanTokens(function(D,G,J){var C,I,H,B,K,F,E,A;K=D[0];if(K==="CLASS"||K==="IF"||K==="FOR"||K==="WHILE"){y=true}F=J.slice(G-1,(G+1)+1||9000000000),B=F[0],I=F[1],H=F[2];C=!y&&K==="INDENT"&&H&&H.generated&&H[0]==="{"&&B&&(E=B[0],d.call(p,E)>=0);x=false;w=false;if(d.call(e,K)>=0){y=false}if(B&&!B.spaced&&K==="?"){D.call=true}if(D.fromThen){return 1}if(!(C||(B!=null?B.spaced:void 0)&&(B.call||(A=B[0],d.call(p,A)>=0))&&(d.call(k,K)>=0||!(D.spaced||D.newLine)&&d.call(s,K)>=0))){return 1}J.splice(G,0,this.generate("CALL_START","(",D[2]));this.detectEnd(G+1,z,v);if(B[0]==="?"){B[0]="FUNC_EXIST"}return 2})};u.prototype.addImplicitIndentation=function(){var w,z,v,x,y;y=v=x=null;z=function(B,A){var C;return B[1]!==";"&&(C=B[0],d.call(n,C)>=0)&&!(B[0]==="ELSE"&&(y!=="IF"&&y!=="THEN"))};w=function(B,A){return this.tokens.splice((this.tag(A-1)===","?A-1:A),0,x)};return this.scanTokens(function(D,C,F){var B,E,A;B=D[0];if(B==="TERMINATOR"&&this.tag(C+1)==="THEN"){F.splice(C,1);return 0}if(B==="ELSE"&&this.tag(C-1)!=="OUTDENT"){F.splice.apply(F,[C,0].concat(o.call(this.indentation(D))));return 2}if(B==="CATCH"&&((E=this.tag(C+2))==="OUTDENT"||E==="TERMINATOR"||E==="FINALLY")){F.splice.apply(F,[C+2,0].concat(o.call(this.indentation(D))));return 4}if(d.call(q,B)>=0&&this.tag(C+1)!=="INDENT"&&!(B==="ELSE"&&this.tag(C+1)==="IF")){y=B;A=this.indentation(D,true),v=A[0],x=A[1];if(y==="THEN"){v.fromThen=true}F.splice(C+1,0,v);this.detectEnd(C+2,z,w);if(B==="THEN"){F.splice(C,1)}return 1}return 1})};u.prototype.tagPostfixConditionals=function(){var w,x,v;v=null;x=function(z,y){var A;return(A=z[0])==="TERMINATOR"||A==="INDENT"};w=function(z,y){if(z[0]!=="INDENT"||(z.generated&&!z.fromThen)){return v[0]="POST_"+v[0]}};return this.scanTokens(function(z,y){if(z[0]!=="IF"){return 1}v=z;this.detectEnd(y+1,x,w);return 1})};u.prototype.indentation=function(x,w){var v,y;if(w==null){w=false}v=["INDENT",2,x[2]];y=["OUTDENT",2,x[2]];if(w){v.generated=y.generated=true}return[v,y]};u.prototype.generate=function(v,y,w){var x;x=[v,y,w];x.generated=true;return x};u.prototype.tag=function(v){var w;return(w=this.tokens[v])!=null?w[0]:void 0};return u})();c=[["(",")"],["[","]"],["{","}"],["INDENT","OUTDENT"],["CALL_START","CALL_END"],["PARAM_START","PARAM_END"],["INDEX_START","INDEX_END"]];exports.INVERSES=j={};r=[];a=[];for(b=0,t=c.length;b<t;b++){m=c[b],g=m[0],l=m[1];r.push(j[l]=g);a.push(j[g]=l)}f=["CATCH","WHEN","ELSE","FINALLY"].concat(a);p=["IDENTIFIER","SUPER",")","CALL_END","]","INDEX_END","@","THIS"];k=["IDENTIFIER","NUMBER","STRING","JS","REGEX","NEW","PARAM_START","CLASS","IF","TRY","SWITCH","THIS","BOOL","NULL","UNDEFINED","UNARY","SUPER","@","->","=>","[","(","{","--","++"];s=["+","-"];i=["->","=>","{","[",","];h=["POST_IF","FOR","WHILE","UNTIL","WHEN","BY","LOOP","TERMINATOR"];q=["ELSE","->","=>","TRY","FINALLY","THEN"];n=["TERMINATOR","CATCH","FINALLY","ELSE","OUTDENT","LEADING_WHEN"];e=["TERMINATOR","INDENT","OUTDENT"]}).call(this);