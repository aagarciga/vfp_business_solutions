(function(){var r,n,x,J,A,o,e,H,c,l,N,q,V,m,W,u,b,w,O,d,L,B,R,E,S,K,D,P,F,C,Q,h,y,a,t,G,g,v,U,z,i,T,M,s,p,f,I,k,j=[].indexOf||function(Z){for(var Y=0,X=this.length;Y<X;Y++){if(Y in this&&this[Y]===Z){return Y}}return -1};I=require("./rewriter"),t=I.Rewriter,b=I.INVERSES;k=require("./helpers"),M=k.count,f=k.starts,T=k.compact,p=k.last;exports.Lexer=E=(function(){function X(){}X.prototype.tokenize=function(ab,aa){var Z,Y;if(aa==null){aa={}}if(i.test(ab)){ab="\n"+ab}ab=ab.replace(/\r/g,"").replace(U,"");this.code=ab;this.line=aa.line||0;this.indent=0;this.indebt=0;this.outdebt=0;this.indents=[];this.ends=[];this.tokens=[];Z=0;while(this.chunk=ab.slice(Z)){Z+=this.identifierToken()||this.commentToken()||this.whitespaceToken()||this.lineToken()||this.heredocToken()||this.stringToken()||this.numberToken()||this.regexToken()||this.jsToken()||this.literalToken()}this.closeIndentation();if(Y=this.ends.pop()){this.error("missing "+Y)}if(aa.rewrite===false){return this.tokens}return(new t).rewrite(this.tokens)};X.prototype.identifierToken=function(){var ae,Z,Y,af,ad,ac,ag,ab,aa;if(!(ad=W.exec(this.chunk))){return 0}af=ad[0],Y=ad[1],ae=ad[2];if(Y==="own"&&this.tag()==="FOR"){this.token("OWN",Y);return Y.length}Z=ae||(ac=p(this.tokens))&&(((ab=ac[0])==="."||ab==="?."||ab==="::")||!ac.spaced&&ac[0]==="@");ag="IDENTIFIER";if(!Z&&(j.call(d,Y)>=0||j.call(o,Y)>=0)){ag=Y.toUpperCase();if(ag==="WHEN"&&(aa=this.tag(),j.call(L,aa)>=0)){ag="LEADING_WHEN"}else{if(ag==="FOR"){this.seenFor=true}else{if(ag==="UNLESS"){ag="IF"}else{if(j.call(z,ag)>=0){ag="UNARY"}else{if(j.call(y,ag)>=0){if(ag!=="INSTANCEOF"&&this.seenFor){ag="FOR"+ag;this.seenFor=false}else{ag="RELATION";if(this.value()==="!"){this.tokens.pop();Y="!"+Y}}}}}}}}if(j.call(O,Y)>=0){if(Z){ag="IDENTIFIER";Y=new String(Y);Y.reserved=true}else{if(j.call(a,Y)>=0){this.error('reserved word "'+Y+'"')}}}if(!Z){if(j.call(J,Y)>=0){Y=A[Y]}ag=(function(){switch(Y){case"!":return"UNARY";case"==":case"!=":return"COMPARE";case"&&":case"||":return"LOGIC";case"true":case"false":return"BOOL";case"break":case"continue":return"STATEMENT";default:return ag}})()}this.token(ag,Y);if(ae){this.token(":",":")}return af.length};X.prototype.numberToken=function(){var ac,Z,Y,aa,ab;if(!(Y=C.exec(this.chunk))){return 0}aa=Y[0];if(/^0[BOX]/.test(aa)){this.error("radix prefix '"+aa+"' must be lowercase")}else{if(/E/.test(aa)&&!/^0x/.test(aa)){this.error("exponential notation '"+aa+"' must be indicated with a lowercase 'e'")}else{if(/^0\d*[89]/.test(aa)){this.error("decimal literal '"+aa+"' must not be prefixed with '0'")}else{if(/^0\d+/.test(aa)){this.error("octal literal '"+aa+"' must be prefixed with '0o'")}}}}Z=aa.length;if(ab=/^0o([0-7]+)/.exec(aa)){aa="0x"+(parseInt(ab[1],8)).toString(16)}if(ac=/^0b([01]+)/.exec(aa)){aa="0x"+(parseInt(ac[1],2)).toString(16)}this.token("NUMBER",aa);return Z};X.prototype.stringToken=function(){var Z,aa,Y;switch(this.chunk.charAt(0)){case"'":if(!(Z=g.exec(this.chunk))){return 0}this.token("STRING",(Y=Z[0]).replace(K,"\\\n"));break;case'"':if(!(Y=this.balancedString(this.chunk,'"'))){return 0}if(0<Y.indexOf("#{",1)){this.interpolateString(Y.slice(1,-1))}else{this.token("STRING",this.escapeLines(Y))}break;default:return 0}if(aa=/^(?:\\.|[^\\])*\\(?:0[0-7]|[1-7])/.test(Y)){this.error("octal escape sequences "+Y+" are not allowed")}this.line+=M(Y,"\n");return Y.length};X.prototype.heredocToken=function(){var ab,Y,aa,Z;if(!(aa=l.exec(this.chunk))){return 0}Y=aa[0];Z=Y.charAt(0);ab=this.sanitizeHeredoc(aa[2],{quote:Z,indent:null});if(Z==='"'&&0<=ab.indexOf("#{")){this.interpolateString(ab,{heredoc:true})}else{this.token("STRING",this.makeString(ab,Z,true))}this.line+=M(Y,"\n");return Y.length};X.prototype.commentToken=function(){var aa,Z,Y;if(!(Y=this.chunk.match(e))){return 0}aa=Y[0],Z=Y[1];if(Z){this.token("HERECOMMENT",this.sanitizeHeredoc(Z,{herecomment:true,indent:Array(this.indent+1).join(" ")}))}this.line+=M(aa,"\n");return aa.length};X.prototype.jsToken=function(){var Z,Y;if(!(this.chunk.charAt(0)==="`"&&(Z=w.exec(this.chunk)))){return 0}this.token("JS",(Y=Z[0]).slice(1,-1));return Y.length};X.prototype.regexToken=function(){var Y,ac,Z,ab,aa,ae,ad;if(this.chunk.charAt(0)!=="/"){return 0}if(Z=V.exec(this.chunk)){ac=this.heregexToken(Z);this.line+=M(Z[0],"\n");return ac}ab=p(this.tokens);if(ab&&(ae=ab[0],j.call((ab.spaced?P:F),ae)>=0)){return 0}if(!(Z=h.exec(this.chunk))){return 0}ad=Z,Z=ad[0],aa=ad[1],Y=ad[2];if(aa.slice(0,2)==="/*"){this.error("regular expressions cannot begin with `*`")}if(aa==="//"){aa="/(?:)/"}this.token("REGEX",""+aa+Y);return Z.length};X.prototype.heregexToken=function(af){var ag,ab,aa,ak,al,ah,aj,ae,ai,ad,ac,Z,Y;aa=af[0],ag=af[1],ab=af[2];if(0>ag.indexOf("#{")){ak=ag.replace(m,"").replace(/\//g,"\\/");if(ak.match(/^\*/)){this.error("regular expressions cannot begin with `*`")}this.token("REGEX","/"+(ak||"(?:)")+"/"+ab);return aa.length}this.token("IDENTIFIER","RegExp");this.tokens.push(["CALL_START","("]);ah=[];ad=this.interpolateString(ag,{regex:true});for(ae=0,ai=ad.length;ae<ai;ae++){ac=ad[ae],al=ac[0],aj=ac[1];if(al==="TOKENS"){ah.push.apply(ah,aj)}else{if(!(aj=aj.replace(m,""))){continue}aj=aj.replace(/\\/g,"\\\\");ah.push(["STRING",this.makeString(aj,'"',true)])}ah.push(["+","+"])}ah.pop();if(((Z=ah[0])!=null?Z[0]:void 0)!=="STRING"){this.tokens.push(["STRING",'""'],["+","+"])}(Y=this.tokens).push.apply(Y,ah);if(ab){this.tokens.push([",",","],["STRING",'"'+ab+'"'])}this.token(")",")");return aa.length};X.prototype.lineToken=function(){var ad,Y,aa,Z,ac,ab;if(!(aa=D.exec(this.chunk))){return 0}Y=aa[0];this.line+=M(Y,"\n");this.seenFor=false;ac=p(this.tokens,1);ab=Y.length-1-Y.lastIndexOf("\n");Z=this.unfinished();if(ab-this.indebt===this.indent){if(Z){this.suppressNewlines()}else{this.newlineToken()}return Y.length}if(ab>this.indent){if(Z){this.indebt=ab-this.indent;this.suppressNewlines();return Y.length}ad=ab-this.indent+this.outdebt;this.token("INDENT",ad);this.indents.push(ad);this.ends.push("OUTDENT");this.outdebt=this.indebt=0}else{this.indebt=0;this.outdentToken(this.indent-ab,Z)}this.indent=ab;return Y.length};X.prototype.outdentToken=function(ab,Z){var aa,Y;while(ab>0){Y=this.indents.length-1;if(this.indents[Y]===void 0){ab=0}else{if(this.indents[Y]===this.outdebt){ab-=this.outdebt;this.outdebt=0}else{if(this.indents[Y]<this.outdebt){this.outdebt-=this.indents[Y];ab-=this.indents[Y]}else{aa=this.indents.pop()-this.outdebt;ab-=aa;this.outdebt=0;this.pair("OUTDENT");this.token("OUTDENT",aa)}}}}if(aa){this.outdebt-=ab}while(this.value()===";"){this.tokens.pop()}if(!(this.tag()==="TERMINATOR"||Z)){this.token("TERMINATOR","\n")}return this};X.prototype.whitespaceToken=function(){var Z,Y,aa;if(!((Z=i.exec(this.chunk))||(Y=this.chunk.charAt(0)==="\n"))){return 0}aa=p(this.tokens);if(aa){aa[Z?"spaced":"newLine"]=true}if(Z){return Z[0].length}else{return 0}};X.prototype.newlineToken=function(){while(this.value()===";"){this.tokens.pop()}if(this.tag()!=="TERMINATOR"){this.token("TERMINATOR","\n")}return this};X.prototype.suppressNewlines=function(){if(this.value()==="\\"){this.tokens.pop()}return this};X.prototype.literalToken=function(){var Z,aa,Y,ac,af,ae,ad,ab;if(Z=Q.exec(this.chunk)){ac=Z[0];if(x.test(ac)){this.tagParameters()}}else{ac=this.chunk.charAt(0)}Y=ac;aa=p(this.tokens);if(ac==="="&&aa){if(!aa[1].reserved&&(af=aa[1],j.call(O,af)>=0)){this.error('reserved word "'+(this.value())+"\" can't be assigned")}if((ae=aa[1])==="||"||ae==="&&"){aa[0]="COMPOUND_ASSIGN";aa[1]+="=";return ac.length}}if(ac===";"){this.seenFor=false;Y="TERMINATOR"}else{if(j.call(S,ac)>=0){Y="MATH"}else{if(j.call(H,ac)>=0){Y="COMPARE"}else{if(j.call(c,ac)>=0){Y="COMPOUND_ASSIGN"}else{if(j.call(z,ac)>=0){Y="UNARY"}else{if(j.call(G,ac)>=0){Y="SHIFT"}else{if(j.call(R,ac)>=0||ac==="?"&&(aa!=null?aa.spaced:void 0)){Y="LOGIC"}else{if(aa&&!aa.spaced){if(ac==="("&&(ad=aa[0],j.call(n,ad)>=0)){if(aa[0]==="?"){aa[0]="FUNC_EXIST"}Y="CALL_START"}else{if(ac==="["&&(ab=aa[0],j.call(u,ab)>=0)){Y="INDEX_START";switch(aa[0]){case"?":aa[0]="INDEX_SOAK"}}}}}}}}}}}switch(ac){case"(":case"{":case"[":this.ends.push(b[ac]);break;case")":case"}":case"]":this.pair(ac)}this.token(Y,ac);return ac.length};X.prototype.sanitizeHeredoc=function(ad,aa){var ac,ab,Y,Z,ae;Y=aa.indent,ab=aa.herecomment;if(ab){if(N.test(ad)){this.error('block comment cannot contain "*/", starting')}if(ad.indexOf("\n")<=0){return ad}}else{while(Z=q.exec(ad)){ac=Z[1];if(Y===null||(0<(ae=ac.length)&&ae<Y.length)){Y=ac}}}if(Y){ad=ad.replace(RegExp("\\n"+Y,"g"),"\n")}if(!ab){ad=ad.replace(/^\n/,"")}return ad};X.prototype.tagParameters=function(){var aa,Y,Z,ab;if(this.tag()!==")"){return this}Y=[];ab=this.tokens;aa=ab.length;ab[--aa][0]="PARAM_END";while(Z=ab[--aa]){switch(Z[0]){case")":Y.push(Z);break;case"(":case"CALL_START":if(Y.length){Y.pop()}else{if(Z[0]==="("){Z[0]="PARAM_START";return this}else{return this}}}}return this};X.prototype.closeIndentation=function(){return this.outdentToken(this.indent)};X.prototype.balancedString=function(ag,ab){var af,ad,Y,ae,aa,ah,ac,Z;af=0;ah=[ab];for(ad=ac=1,Z=ag.length;1<=Z?ac<Z:ac>Z;ad=1<=Z?++ac:--ac){if(af){--af;continue}switch(Y=ag.charAt(ad)){case"\\":++af;continue;case ab:ah.pop();if(!ah.length){return ag.slice(0,ad+1||9000000000)}ab=ah[ah.length-1];continue}if(ab==="}"&&(Y==='"'||Y==="'")){ah.push(ab=Y)}else{if(ab==="}"&&Y==="/"&&(ae=V.exec(ag.slice(ad))||h.exec(ag.slice(ad)))){af+=ae[0].length-1}else{if(ab==="}"&&Y==="{"){ah.push(ab="}")}else{if(ab==='"'&&aa==="#"&&Y==="{"){ah.push(ab="}")}}}}aa=Y}return this.error("missing "+(ah.pop())+", starting")};X.prototype.interpolateString=function(ak,ad){var ac,ag,al,aq,ah,am,ap,af,an,ae,ar,ai,aj,aa,ao,ab,Z,Y;if(ad==null){ad={}}ag=ad.heredoc,ae=ad.regex;ai=[];an=0;al=-1;while(ap=ak.charAt(al+=1)){if(ap==="\\"){al+=1;continue}if(!(ap==="#"&&ak.charAt(al+1)==="{"&&(ac=this.balancedString(ak.slice(al+1),"}")))){continue}if(an<al){ai.push(["NEOSTRING",ak.slice(an,al)])}aq=ac.slice(1,-1);if(aq.length){af=new X().tokenize(aq,{line:this.line,rewrite:false});af.pop();if(((ab=af[0])!=null?ab[0]:void 0)==="TERMINATOR"){af.shift()}if(am=af.length){if(am>1){af.unshift(["(","(",this.line]);af.push([")",")",this.line])}ai.push(["TOKENS",af])}}al+=ac.length;an=al+1}if((al>an&&an<ak.length)){ai.push(["NEOSTRING",ak.slice(an)])}if(ae){return ai}if(!ai.length){return this.token("STRING",'""')}if(ai[0][0]!=="NEOSTRING"){ai.unshift(["",""])}if(ah=ai.length>1){this.token("(","(")}for(al=aa=0,ao=ai.length;aa<ao;al=++aa){Z=ai[al],ar=Z[0],aj=Z[1];if(al){this.token("+","+")}if(ar==="TOKENS"){(Y=this.tokens).push.apply(Y,aj)}else{this.token("STRING",this.makeString(aj,'"',ag))}}if(ah){this.token(")",")")}return ai};X.prototype.pair=function(Y){var aa,Z;if(Y!==(Z=p(this.ends))){if("OUTDENT"!==Z){this.error("unmatched "+Y)}this.indent-=aa=p(this.indents);this.outdentToken(aa,true);return this.pair(Y)}return this.ends.pop()};X.prototype.token=function(Y,Z){return this.tokens.push([Y,Z,this.line])};X.prototype.tag=function(aa,Y){var Z;return(Z=p(this.tokens,aa))&&(Y?Z[0]=Y:Z[0])};X.prototype.value=function(Z,aa){var Y;return(Y=p(this.tokens,Z))&&(aa?Y[1]=aa:Y[1])};X.prototype.unfinished=function(){var Y;return B.test(this.chunk)||((Y=this.tag())==="\\"||Y==="."||Y==="?."||Y==="UNARY"||Y==="MATH"||Y==="+"||Y==="-"||Y==="SHIFT"||Y==="RELATION"||Y==="COMPARE"||Y==="LOGIC"||Y==="THROW"||Y==="EXTENDS")};X.prototype.escapeLines=function(Z,Y){return Z.replace(K,Y?"\\n":"")};X.prototype.makeString=function(Y,aa,Z){if(!Y){return aa+aa}Y=Y.replace(/\\([\s\S])/g,function(ab,ac){if(ac==="\n"||ac===aa){return ac}else{return ab}});Y=Y.replace(RegExp(""+aa,"g"),"\\$&");return aa+this.escapeLines(Y,Z)+aa};X.prototype.error=function(Y){throw SyntaxError(""+Y+" on line "+(this.line+1))};return X})();d=["true","false","null","this","new","delete","typeof","in","instanceof","return","throw","break","continue","debugger","if","else","switch","for","while","do","try","catch","finally","class","extends","super"];o=["undefined","then","unless","until","loop","of","by","when"];A={and:"&&",or:"||",is:"==",isnt:"!=",not:"!",yes:"true",no:"false",on:"true",off:"false"};J=(function(){var X;X=[];for(s in A){X.push(s)}return X})();o=o.concat(J);a=["case","default","function","var","void","with","const","let","enum","export","import","native","__hasProp","__extends","__slice","__bind","__indexOf","implements","interface","let","package","private","protected","public","static","yield"];v=["arguments","eval"];O=d.concat(a).concat(v);exports.RESERVED=a.concat(d).concat(o).concat(v);exports.STRICT_PROSCRIBED=v;W=/^([$A-Za-z_\x7f-\uffff][$\w\x7f-\uffff]*)([^\n\S]*:(?!:))?/;C=/^0b[01]+|^0o[0-7]+|^0x[\da-f]+|^\d*\.?\d+(?:e[+-]?\d+)?/i;l=/^("""|''')([\s\S]*?)(?:\n[^\n\S]*)?\1/;Q=/^(?:[-=]>|[-+*\/%<>&|^!?=]=|>>>=?|([-+:])\1|([&|<>])\2=?|\?\.|\.{2,3})/;i=/^[^\n\S]+/;e=/^###([^#][\s\S]*?)(?:###[^\n\S]*|(?:###)?$)|^(?:\s*#(?!##[^#]).*)+/;x=/^[-=]>/;D=/^(?:\n[^\n\S]*)+/;g=/^'[^\\']*(?:\\.[^\\']*)*'/;w=/^`[^\\`]*(?:\\.[^\\`]*)*`/;h=/^(\/(?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/)([imgy]{0,4})(?!\w)/;V=/^\/{3}([\s\S]+?)\/{3}([imgy]{0,4})(?!\w)/;m=/\s+(?:#.*)?/g;K=/\n/g;q=/\n+([^\n\S]*)/g;N=/\*\//;B=/^\s*(?:,|\??\.(?![.\d])|::)/;U=/\s+$/;c=["-=","+=","/=","*=","%=","||=","&&=","?=","<<=",">>=",">>>=","&=","^=","|="];z=["!","~","NEW","TYPEOF","DELETE","DO"];R=["&&","||","&","|","^"];G=["<<",">>",">>>"];H=["==","!=","<",">","<=",">="];S=["*","/","%"];y=["IN","OF","INSTANCEOF"];r=["TRUE","FALSE"];P=["NUMBER","REGEX","BOOL","NULL","UNDEFINED","++","--","]"];F=P.concat(")","}","THIS","IDENTIFIER","STRING");n=["IDENTIFIER","STRING","REGEX",")","]","}","?","::","@","THIS","SUPER"];u=n.concat("NUMBER","BOOL","NULL","UNDEFINED");L=["INDENT","OUTDENT","TERMINATOR"]}).call(this);