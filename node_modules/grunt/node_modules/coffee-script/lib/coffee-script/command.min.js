(function(){var J,N,p,i,O,E,t,f,z,x,n,s,B,m,r,d,g,I,v,j,u,w,y,F,b,o,e,H,c,C,l,a,G,k,K,h,q,A,L,M,D;s=require("fs");F=require("path");B=require("./helpers");j=require("./optparse");N=require("./coffee-script");D=require("child_process"),l=D.spawn,x=D.exec;p=require("events").EventEmitter;B.extend(N,new p);b=function(P){return process.stdout.write(P+"\n")};e=function(P){return process.stderr.write(P+"\n")};m=function(P){return/^\.|~$/.test(P)};J="Usage: coffee [options] path/to/script.coffee -- [args]\n\nIf called without options, `coffee` will run your script.";i=[["-b","--bare","compile without a top-level function wrapper"],["-c","--compile","compile to JavaScript and save as .js files"],["-e","--eval","pass a string from the command line as input"],["-h","--help","display this help message"],["-i","--interactive","run an interactive CoffeeScript REPL"],["-j","--join [FILE]","concatenate the source CoffeeScript before compiling"],["-l","--lint","pipe the compiled JavaScript through JavaScript Lint"],["-n","--nodes","print out the parse tree that the parser produces"],["--nodejs [ARGS]",'pass options directly to the "node" binary'],["-o","--output [DIR]","set the output directory for compiled JavaScript"],["-p","--print","print out the compiled JavaScript"],["-r","--require [FILE*]","require a library before executing your script"],["-s","--stdio","listen for and compile scripts over stdio"],["-t","--tokens","print out the tokens that the lexer/rewriter produce"],["-v","--version","display the version number"],["-w","--watch","watch scripts for changes and rerun commands"]];u={};C=[];c=[];I={};L={};v=null;exports.run=function(){var T,S,R,Q,P;y();if(u.nodejs){return n()}if(u.help){return k()}if(u.version){return K()}if(u.require){g()}if(u.interactive){return require("./repl")}if(u.watch&&!s.watch){return e("The --watch feature depends on Node v0.6.0+. You are running "+process.version+".")}if(u.stdio){return z()}if(u["eval"]){return f(null,C[0])}if(!C.length){return require("./repl")}T=u.run?C.splice(1):[];process.argv=process.argv.slice(0,2).concat(T);process.argv[0]="coffee";process.execPath=require.main.filename;P=[];for(R=0,Q=C.length;R<Q;R++){S=C[R];P.push(t(S,true,F.normalize(S)))}return P};t=function(R,P,Q){return s.stat(R,function(T,S){if(T&&T.code!=="ENOENT"){throw T}if((T!=null?T.code:void 0)==="ENOENT"){if(P&&R.slice(-7)!==".coffee"){R=C[C.indexOf(R)]=""+R+".coffee";return t(R,P,Q)}if(P){console.error("File not found: "+R);process.exit(1)}return}if(S.isDirectory()){if(u.watch){A(R,Q)}return s.readdir(R,function(Y,X){var W,V,U,Z;if(Y&&Y.code!=="ENOENT"){throw Y}if((Y!=null?Y.code:void 0)==="ENOENT"){return}V=C.indexOf(R);X=X.filter(function(aa){return !m(aa)});[].splice.apply(C,[V,V-V+1].concat(U=(function(){var ac,ab,aa;aa=[];for(ac=0,ab=X.length;ac<ab;ac++){W=X[ac];aa.push(F.join(R,W))}return aa})())),U;[].splice.apply(c,[V,V-V+1].concat(Z=X.map(function(){return null}))),Z;return X.forEach(function(aa){return t(F.join(R,aa),false,Q)})})}else{if(P||F.extname(R)===".coffee"){if(u.watch){q(R,Q)}return s.readFile(R,function(V,U){if(V&&V.code!=="ENOENT"){throw V}if((V!=null?V.code:void 0)==="ENOENT"){return}return f(R,U.toString(),Q)})}else{I[R]=true;return H(R,Q)}}})};f=function(T,Q,V){var W,R,S,P;W=u;R=E(T);try{S=P={file:T,input:Q,options:R};N.emit("compile",P);if(W.tokens){return o(N.tokens(S.input))}else{if(W.nodes){return b(N.nodes(S.input).toString().trim())}else{if(W.run){return N.run(S.input,S.options)}else{if(W.join&&S.file!==W.join){c[C.indexOf(S.file)]=S.input;return O()}else{S.output=N.compile(S.input,S.options);N.emit("success",P);if(W.print){return b(S.output.trim())}else{if(W.compile){return M(S.file,S.output,V)}else{if(W.lint){return d(S.file,S.output)}}}}}}}}catch(U){N.emit("failure",U,P);if(N.listeners("failure").length){return}if(W.watch){return b(U.message+"\x07")}e(U instanceof Error&&U.stack||("ERROR: "+U));return process.exit(1)}};z=function(){var P,Q;P="";Q=process.openStdin();Q.on("data",function(R){if(R){return P+=R.toString()}});return Q.on("end",function(){return f(null,P)})};r=null;O=function(){if(!u.join){return}if(!c.some(function(P){return P===null})){clearTimeout(r);return r=h(100,function(){return f(u.join,c.join("\n"),u.join)})}};g=function(){var R,S,T,Q,P;R=module.filename;module.filename=".";P=u.require;for(T=0,Q=P.length;T<Q;T++){S=P[T];require(S)}return module.filename=R};q=function(P,Q){var X,V,R,S,T,W;R=null;V=null;T=function(Y){if(Y.code==="ENOENT"){if(C.indexOf(P)===-1){return}try{S();return X()}catch(Y){H(P,Q,true);return O()}}else{throw Y}};X=function(){clearTimeout(V);return V=h(25,function(){return s.stat(P,function(Z,Y){if(Z){return T(Z)}if(R&&Y.size===R.size&&Y.mtime.getTime()===R.mtime.getTime()){return S()}R=Y;return s.readFile(P,function(ab,aa){if(ab){return T(ab)}f(P,aa.toString(),Q);return S()})})})};try{W=s.watch(P,X)}catch(U){T(U)}return S=function(){if(W!=null){W.close()}return W=s.watch(P,X)}};A=function(R,Q){var T,P;T=null;try{return P=s.watch(R,function(){clearTimeout(T);return T=h(25,function(){return s.readdir(R,function(Y,X){var W,Z,V,U;if(Y){if(Y.code!=="ENOENT"){throw Y}P.close();return G(R,Q)}U=[];for(Z=0,V=X.length;Z<V;Z++){W=X[Z];if(!(!m(W)&&!I[W])){continue}W=F.join(R,W);if(C.some(function(aa){return aa.indexOf(W)>=0})){continue}C.push(W);c.push(null);U.push(t(W,false,Q))}return U})})})}catch(S){if(S.code!=="ENOENT"){throw S}}};G=function(V,U){var R,P,S,T,Q;P=C.slice(0);S=(function(){var Y,X,W;W=[];for(Y=0,X=C.length;Y<X;Y++){R=C[Y];if(R.indexOf(V)>=0){W.push(R)}}return W})();for(T=0,Q=S.length;T<Q;T++){R=S[T];H(R,U,true)}if(!C.some(function(X,W){return P[W]!==X})){return}return O()};H=function(R,Q,T){var P,S;P=C.indexOf(R);C.splice(P,1);c.splice(P,1);if(T&&!u.join){S=w(R,Q);return F.exists(S,function(U){if(U){return s.unlink(S,function(V){if(V&&V.code!=="ENOENT"){throw V}return a("removed "+R)})}})}};w=function(T,S){var R,Q,P,U;P=F.basename(T,F.extname(T))+".js";U=F.dirname(T);R=S==="."?U:U.substring(S.length);Q=u.output?F.join(u.output,R):U;return F.join(Q,P)};M=function(S,U,R){var Q,P,T;T=w(S,R);P=F.dirname(T);Q=function(){if(U.length<=0){U=" "}return s.writeFile(T,U,function(V){if(V){return b(V.message)}else{if(u.compile&&u.watch){return a("compiled "+S)}}})};return F.exists(P,function(V){if(V){return Q()}else{return x("mkdir -p "+P,Q)}})};h=function(P,Q){return setTimeout(Q,P)};a=function(P){return console.log(""+((new Date).toLocaleTimeString())+" - "+P)};d=function(R,T){var Q,S,P;P=function(U){return b(R+":\t"+U.toString().trim())};Q=__dirname+"/../../extras/jsl.conf";S=l("jsl",["-nologo","-stdin","-conf",Q]);S.stdout.on("data",P);S.stderr.on("data",P);S.stdin.write(T);return S.stdin.end()};o=function(T){var Q,P,R,S;Q=(function(){var X,W,U,V;V=[];for(X=0,W=T.length;X<W;X++){R=T[X];U=[R[0],R[1].toString().replace(/\n/,"\\n")],P=U[0],S=U[1];V.push("["+P+" "+S+"]")}return V})();return b(Q.join(" "))};y=function(){var Q,T,S,R,P;v=new j.OptionParser(i,J);T=u=v.parse(process.argv.slice(2));T.compile||(T.compile=!!T.output);T.run=!(T.compile||T.print||T.lint);T.print=!!(T.print||(T["eval"]||T.stdio&&T.compile));C=T["arguments"];for(Q=R=0,P=C.length;R<P;Q=++R){S=C[Q];c[Q]=null}};E=function(P){return{filename:P,bare:u.bare,header:u.compile}};n=function(){var P,Q;Q=u.nodejs.split(/\s+/);P=process.argv.slice(1);P.splice(P.indexOf("--nodejs"),2);return l(process.execPath,Q.concat(P),{cwd:process.cwd(),env:process.env,customFds:[0,1,2]})};k=function(){return b((new j.OptionParser(i,J)).help())};K=function(){return b("CoffeeScript version "+N.VERSION)}}).call(this);