var test=require("tap").test,LRU=require("../");test("basic",function(b){var a=new LRU({max:10});a.set("key","value");b.equal(a.get("key"),"value");b.equal(a.get("nada"),undefined);b.equal(a.length,1);b.equal(a.max,10);b.end()});test("least recently set",function(b){var a=new LRU(2);a.set("a","A");a.set("b","B");a.set("c","C");b.equal(a.get("c"),"C");b.equal(a.get("b"),"B");b.equal(a.get("a"),undefined);b.end()});test("lru recently gotten",function(b){var a=new LRU(2);a.set("a","A");a.set("b","B");a.get("a");a.set("c","C");b.equal(a.get("c"),"C");b.equal(a.get("b"),undefined);b.equal(a.get("a"),"A");b.end()});test("del",function(b){var a=new LRU(2);a.set("a","A");a.del("a");b.equal(a.get("a"),undefined);b.end()});test("max",function(c){var a=new LRU(3);a.max=100;for(var b=0;b<100;b++){a.set(b,b)}c.equal(a.length,100);for(var b=0;b<100;b++){c.equal(a.get(b),b)}a.max=3;c.equal(a.length,3);for(var b=0;b<97;b++){c.equal(a.get(b),undefined)}for(var b=98;b<100;b++){c.equal(a.get(b),b)}a.max="hello";for(var b=0;b<100;b++){a.set(b,b)}c.equal(a.length,100);for(var b=0;b<100;b++){c.equal(a.get(b),b)}a.max=3;c.equal(a.length,3);for(var b=0;b<97;b++){c.equal(a.get(b),undefined)}for(var b=98;b<100;b++){c.equal(a.get(b),b)}c.end()});test("reset",function(b){var a=new LRU(10);a.set("a","A");a.set("b","B");a.reset();b.equal(a.length,0);b.equal(a.max,10);b.equal(a.get("a"),undefined);b.equal(a.get("b"),undefined);b.end()});test("dump",function(b){var a=new LRU(10);var c=a.dump();b.equal(Object.keys(c).length,0,"nothing in dump for empty cache");a.set("a","A");var c=a.dump();b.ok(c.a);b.equal(c.a.key,"a");b.equal(c.a.value,"A");b.equal(c.a.lu,0);a.set("b","B");a.get("b");c=a.dump();b.ok(c.b);b.equal(c.b.key,"b");b.equal(c.b.value,"B");b.equal(c.b.lu,2);b.end()});test("basic with weighed length",function(b){var a=new LRU({max:100,length:function(c){return c.size}});a.set("key",{val:"value",size:50});b.equal(a.get("key").val,"value");b.equal(a.get("nada"),undefined);b.equal(a.lengthCalculator(a.get("key")),50);b.equal(a.length,50);b.equal(a.max,100);b.end()});test("weighed length item too large",function(b){var a=new LRU({max:10,length:function(c){return c.size}});b.equal(a.max,10);a.set("key",{val:"value",size:50});b.equal(a.length,0);b.equal(a.get("key"),undefined);b.end()});test("least recently set with weighed length",function(b){var a=new LRU({max:8,length:function(c){return c.length}});a.set("a","A");a.set("b","BB");a.set("c","CCC");a.set("d","DDDD");b.equal(a.get("d"),"DDDD");b.equal(a.get("c"),"CCC");b.equal(a.get("b"),undefined);b.equal(a.get("a"),undefined);b.end()});test("lru recently gotten with weighed length",function(b){var a=new LRU({max:8,length:function(c){return c.length}});a.set("a","A");a.set("b","BB");a.set("c","CCC");a.get("a");a.get("b");a.set("d","DDDD");b.equal(a.get("c"),undefined);b.equal(a.get("d"),"DDDD");b.equal(a.get("b"),"BB");b.equal(a.get("a"),"A");b.end()});test("set returns proper booleans",function(b){var a=new LRU({max:5,length:function(c){return c.length}});b.equal(a.set("a","A"),true);b.equal(a.set("b","donuts"),false);b.equal(a.set("b","B"),true);b.equal(a.set("c","CCCC"),true);b.end()});test("drop the old items",function(b){var a=new LRU({max:5,maxAge:50});a.set("a","A");setTimeout(function(){a.set("b","b");b.equal(a.get("a"),"A")},25);setTimeout(function(){a.set("c","C");b.notOk(a.get("a"))},60+25);setTimeout(function(){b.notOk(a.get("b"));b.equal(a.get("c"),"C")},90);setTimeout(function(){b.notOk(a.get("c"));b.end()},155)});test("individual item can have it's own maxAge",function(b){var a=new LRU({max:5,maxAge:50});a.set("a","A",20);setTimeout(function(){b.notOk(a.get("a"));b.end()},25)});test("individual item can have it's own maxAge > cache's",function(b){var a=new LRU({max:5,maxAge:20});a.set("a","A",50);setTimeout(function(){b.equal(a.get("a"),"A");b.end()},25)});test("disposal function",function(b){var c=false;var a=new LRU({max:1,dispose:function(d,e){c=e}});a.set(1,1);a.set(2,2);b.equal(c,1);a.set(3,3);b.equal(c,2);a.reset();b.equal(c,3);b.end()});test("disposal function on too big of item",function(b){var c=false;var a=new LRU({max:1,length:function(e){return e.length},dispose:function(e,f){c=f}});var d=[1,2];b.equal(c,false);a.set("obj",d);b.equal(c,d);b.end()});test("has()",function(b){var a=new LRU({max:1,maxAge:10});a.set("foo","bar");b.equal(a.has("foo"),true);a.set("blu","baz");b.equal(a.has("foo"),false);b.equal(a.has("blu"),true);setTimeout(function(){b.equal(a.has("blu"),false);b.end()},15)});test("stale",function(b){var a=new LRU({maxAge:10,stale:true});a.set("foo","bar");b.equal(a.get("foo"),"bar");b.equal(a.has("foo"),true);setTimeout(function(){b.equal(a.has("foo"),false);b.equal(a.get("foo"),"bar");b.equal(a.get("foo"),undefined);b.end()},15)});test("lru update via set",function(b){var a=LRU({max:2});a.set("foo",1);a.set("bar",2);a.del("bar");a.set("baz",3);a.set("qux",4);b.equal(a.get("foo"),undefined);b.equal(a.get("bar"),undefined);b.equal(a.get("baz"),3);b.equal(a.get("qux"),4);b.end()});test("least recently set w/ peek",function(b){var a=new LRU(2);a.set("a","A");a.set("b","B");b.equal(a.peek("a"),"A");a.set("c","C");b.equal(a.get("c"),"C");b.equal(a.get("b"),"B");b.equal(a.get("a"),undefined);b.end()});test("pop the least used item",function(b){var a=new LRU(3),c;a.set("a","A");a.set("b","B");a.set("c","C");b.equal(a.length,3);b.equal(a.max,3);a.get("b","B");c=a.pop();b.equal(c.key,"a");b.equal(c.value,"A");b.equal(a.length,2);b.equal(a.max,3);c=a.pop();b.equal(c.key,"c");b.equal(c.value,"C");b.equal(a.length,1);b.equal(a.max,3);c=a.pop();b.equal(c.key,"b");b.equal(c.value,"B");b.equal(a.length,0);b.equal(a.max,3);c=a.pop();b.equal(c,null);b.equal(a.length,0);b.equal(a.max,3);b.end()});