(function(a){function b(){this.current={};this._tasks={};this._queue=[];this._placeholder={placeholder:true};this._marker={marker:true};this._options={};this._running=false;this._success={}}a.Task=b;a.create=function(){return new b()};b.prototype._throwIfRunning=function(c){if(this._running||!this._options.error){throw c}else{this._options.error.call({name:null},c)}};b.prototype.registerTask=function(c,e,d){if(d==null){d=e;e=null}var f;if(typeof d!=="function"){f=this.parseArgs([d]);d=this.run.bind(this,d);d.alias=true;if(!e){e='Alias for "'+f.join('", "')+'" task'+(f.length===1?"":"s")+"."}}else{if(!e){e="Custom task."}}this._tasks[c]={name:c,info:e,fn:d};return this};b.prototype.isTaskAlias=function(c){return !!this._tasks[c].fn.alias};b.prototype.exists=function(c){return c in this._tasks};b.prototype.renameTask=function(d,c){if(!this._tasks[d]){throw new Error('Cannot rename missing "'+d+'" task.')}this._tasks[c]=this._tasks[d];this._tasks[c].name=c;delete this._tasks[d];return this};b.prototype.parseArgs=function(c){return Array.isArray(c[0])?c[0]:[].slice.call(c)};b.prototype.splitArgs=function(c){if(!c){return[]}c=c.replace(/\\\\/g,"\uFFFF").replace(/\\:/g,"\uFFFE");return c.split(":").map(function(d){return d.replace(/\uFFFE/g,":").replace(/\uFFFF/g,"\\")})};b.prototype._taskPlusArgs=function(f){var h=this.splitArgs(f);var g=h.length;var d;do{d=this._tasks[h.slice(0,g).join(":")]}while(!d&&--g>0);var e=h.slice(g);var c={};e.forEach(function(i){c[i]=true});return{task:d,nameArgs:f,args:e,flags:c}};b.prototype._push=function(d){var c=this._queue.indexOf(this._placeholder);if(c===-1){this._queue=this._queue.concat(d)}else{[].splice.apply(this._queue,[c,0].concat(d))}};b.prototype.run=function(){var d=this.parseArgs(arguments).map(this._taskPlusArgs,this);var c=d.filter(function(e){return !e.task});if(c.length>0){this._throwIfRunning(new Error('Task "'+c[0].nameArgs+'" not found.'));return this}this._push(d);return this};b.prototype.mark=function(){this._push(this._marker);return this};b.prototype.runTaskFn=function(f,h,d,e){var g=false;var c=function(l){var k=null;if(l===false){k=new Error('Task "'+f.nameArgs+'" failed.')}else{if(l instanceof Error||{}.toString.call(l)==="[object Error]"){k=l;l=false}else{l=true}}this.current={};this._success[f.nameArgs]=l;if(!l&&this._options.error){this._options.error.call({name:f.name,nameArgs:f.nameArgs},k)}if(e){process.nextTick(function(){d(k,l)})}else{d(k,l)}}.bind(this);f.async=function(){g=true;return function(k){setTimeout(function(){c(k)},1)}};this.current=f;try{var j=h.call(f);if(!g){c(j)}}catch(i){c(i)}};b.prototype.start=function(c){if(!c){c={}}if(this._running){return false}var d=function(){var e;do{e=this._queue.shift()}while(e===this._placeholder||e===this._marker);if(!e){this._running=false;if(this._options.done){this._options.done()}return}this._queue.unshift(this._placeholder);var f={nameArgs:e.nameArgs,name:e.task.name,args:e.args,flags:e.flags};this.runTaskFn(f,function(){return e.task.fn.apply(this,this.args)},d,!!c.asyncDone)}.bind(this);this._running=true;d()};b.prototype.clearQueue=function(c){if(!c){c={}}if(c.untilMarker){this._queue.splice(0,this._queue.indexOf(this._marker)+1)}else{this._queue=[]}return this};b.prototype.requires=function(){this.parseArgs(arguments).forEach(function(c){var d=this._success[c];if(!d){throw new Error('Required task "'+c+'" '+(d===false?"failed":"must be run first")+".")}}.bind(this))};b.prototype.options=function(c){Object.keys(c).forEach(function(d){this._options[d]=c[d]}.bind(this))}}(typeof exports==="object"&&exports||this));